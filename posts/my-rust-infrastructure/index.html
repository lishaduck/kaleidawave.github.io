<!DOCTYPE html><html lang="en"><head><style>:where(img){height:auto}</style>
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta content="pi8qBei6qHxHyGxm9Eh4WDhPwxU672uIJmfdIqcgIGs" name="google-site-verification">
    <meta content="no-referrer-when-downgrade" name="referrer">

    
    <!-- Cloudflare Web Analytics -->
    <script defer="defer" data-cf-beacon="{&quot;token&quot;: &quot;9a3f0b71c0ea4b3d99621e1b084c24cd&quot;}" src="https://static.cloudflareinsights.com/beacon.min.js"></script>
    <!-- End Cloudflare Web Analytics -->
    

    <title>My Rust infrastructure</title>

    <meta content="My Rust infrastructure" name="title">
    <meta content="My Rust infrastructure" property="og:title">
    <meta content="My Rust infrastructure" property="twitter:title">

    <meta content="Some libraries and tools I have built to help with writing Rust." name="description">
    <meta content="Some libraries and tools I have built to help with writing Rust." property="og:description">
    <meta content="Some libraries and tools I have built to help with writing Rust." property="twitter:description">

    <meta content="website" property="og:type">
    <meta content="https://kaleidawave.github.io/" property="og:url">
    <meta content="summary_large_image" property="twitter:card">
    <meta content="https://kaleidawave.github.io/" property="twitter:url">

    
    <meta content="https://kaleidawave.github.io/media/banners/rust-infrastructure.png" property="twitter:image">
    <meta content="https://kaleidawave.github.io/media/banners/rust-infrastructure.png" property="og:image">
    

    <link rel="preconnect" href="https://fonts.gstatic.com">

    <link rel="preconnect" href="https://fonts.gstatic.com"><link rel="stylesheet" data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400&amp;family=Roboto+Serif&amp;family=Be+Vietnam+Pro:wght@600&amp;display=swap"><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400&amp;family=Roboto+Serif&amp;family=Be+Vietnam+Pro:wght@600&amp;display=swap">@font-face{font-family:Be Vietnam Pro;font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/bevietnampro/v11/QdVMSTAyLFyeg_IDWvOJmVES_HToIW86Rb0JcBaoUUU.woff2)format("woff2");unicode-range:U+102-103,U+110-111,U+128-129,U+168-169,U+1A0-1A1,U+1AF-1B0,U+300-301,U+303-304,U+308-309,U+323,U+329,U+1EA0-1EF9,U+20AB}@font-face{font-family:Be Vietnam Pro;font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/bevietnampro/v11/QdVMSTAyLFyeg_IDWvOJmVES_HToIW87Rb0JcBaoUUU.woff2)format("woff2");unicode-range:U+100-2AF,U+304,U+308,U+329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:Be Vietnam Pro;font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/bevietnampro/v11/QdVMSTAyLFyeg_IDWvOJmVES_HToIW81Rb0JcBao.woff2)format("woff2");unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+304,U+308,U+329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:Inter;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZJhjp-Ek-_EeAmM.woff)format("woff");unicode-range:U+460-52F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:Inter;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZthjp-Ek-_EeAmM.woff)format("woff");unicode-range:U+301,U+400-45F,U+490-491,U+4B0-4B1,U+2116}@font-face{font-family:Inter;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZNhjp-Ek-_EeAmM.woff)format("woff");unicode-range:U+1F??}@font-face{font-family:Inter;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZxhjp-Ek-_EeAmM.woff)format("woff");unicode-range:U+370-377,U+37A-37F,U+384-38A,U+38C,U+38E-3A1,U+3A3-3FF}@font-face{font-family:Inter;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZBhjp-Ek-_EeAmM.woff)format("woff");unicode-range:U+102-103,U+110-111,U+128-129,U+168-169,U+1A0-1A1,U+1AF-1B0,U+300-301,U+303-304,U+308-309,U+323,U+329,U+1EA0-1EF9,U+20AB}@font-face{font-family:Inter;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZFhjp-Ek-_EeAmM.woff)format("woff");unicode-range:U+100-2AF,U+304,U+308,U+329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:Inter;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hjp-Ek-_EeA.woff)format("woff");unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+304,U+308,U+329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:Roboto Serif;font-style:normal;font-weight:400;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/robotoserif/v13/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl618BtxaV4jcFyRM.woff)format("woff");unicode-range:U+460-52F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:Roboto Serif;font-style:normal;font-weight:400;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/robotoserif/v13/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl6R8BtxaV4jcFyRM.woff)format("woff");unicode-range:U+301,U+400-45F,U+490-491,U+4B0-4B1,U+2116}@font-face{font-family:Roboto Serif;font-style:normal;font-weight:400;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/robotoserif/v13/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl698BtxaV4jcFyRM.woff)format("woff");unicode-range:U+102-103,U+110-111,U+128-129,U+168-169,U+1A0-1A1,U+1AF-1B0,U+300-301,U+303-304,U+308-309,U+323,U+329,U+1EA0-1EF9,U+20AB}@font-face{font-family:Roboto Serif;font-style:normal;font-weight:400;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/robotoserif/v13/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl658BtxaV4jcFyRM.woff)format("woff");unicode-range:U+100-2AF,U+304,U+308,U+329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:Roboto Serif;font-style:normal;font-weight:400;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/robotoserif/v13/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl6B8BtxaV4jcFw.woff)format("woff");unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+304,U+308,U+329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style>

    <style>:root{--text-color:#1a1a1a;--border:var(--text-color);--background:#f2f0eb;--muted-background:#f9f5f8;--muted-background-opaque:#f7f7f780;--accent:#bc3b3b;--muted-accent:#993b33;--code-highlight:#e2ccb7;font-family:SF Pro Display,SF Pro Icons,Inter,Helvetica Neue,Helvetica,Arial,sans-serif;font-weight:400}@media screen{:root.dark{--text-color:#dbdbdb;--background:#0f0f10;--muted-background:#1f1f23;--muted-background-opaque:#1f1f2380;--accent:#a8ff8e;--muted-accent:#81b47c;--code-highlight:#549463}}:root.dark .shiki-light,:root:not(.dark) .shiki-dark{display:none}html,body{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin:0;padding:0}body{background-color:var(--background,white);color:var(--text-color,black);flex-direction:column;min-height:100vh;display:flex}header{background-color:var(--muted-background-opaque,white);justify-content:space-around;align-items:center;padding:14px;font-size:16px;display:flex}:root:not(.dark) header{border-bottom:2px solid var(--border)}header>div{justify-content:space-between;align-items:center;display:flex;width:100%!important}header video{position:absolute}header h1{color:var(--text-color);font-size:20px;font-weight:100}header h1>a{color:var(--text-color)!important}header .icon-title{align-items:center;gap:8px;display:flex}header img{width:auto;height:26px;position:relative;top:-4px}@media print{header nav,footer{display:none}}header nav>ul{padding-left:0;list-style:none;display:flex}header nav>ul>li{text-transform:lowercase;margin-left:10px}h1,h2,h3,h4,h5{scroll-margin:100px;font-family:Be Vietnam Pro,sans-serif;font-weight:600}::selection{background:var(--muted-accent);color:var(--background)}em{position:relative;left:-2px}ul,ol{margin:0;padding-left:20px}hr{border:none;border-top:1px solid var(--text-color);width:100%;margin:30px auto}main{margin:20px 0 80px}.width-box{width:95%;margin:0 auto}svg.icon{fill:var(--muted-accent);height:10pt;position:relative;top:2px}a{color:var(--accent,white);text-decoration:none}a:visited{color:var(--muted-accent,white)}pre code{tab-size:4;overflow-x:hidden;white-space:break-spaces!important}:is(div,p,a,li)>code,div>pre{border-radius:4px;font-size:15px}pre,code{font-family:JetBrains Mono,Fira Code light,consolas,monospace;background-color:var(--muted-background)!important}footer{background-color:var(--muted-background,white);margin-top:auto;padding:22px}:root:not(.dark) footer{border-top:2px solid var(--border)}footer>div{justify-content:space-between;align-items:center;display:flex}footer h3{font-weight:inherit;margin:0;font-size:16px}footer nav ul{flex-wrap:wrap;gap:6px;list-style:none;display:flex}footer nav ul>li:not(:first-child){border-left:2px solid var(--muted-accent);padding-left:6px}footer>div>:nth-child(2n){margin-left:auto;font-size:10pt}@media screen and (width<=480px){header>div{flex-direction:column}body{box-sizing:border-box;width:100vw}.posts>ul>li img{width:100%;height:auto}}@media screen and (width>=480px){@supports (backdrop-filter:blur(20px)){header{backdrop-filter:blur(20px)}}header{z-index:100;position:sticky;top:0;left:0;right:0}.width-box{width:100%;max-width:min(80vw,780px)}}</style>
</head>

<body>
    <header>
        <div class="width-box">
            <a href="/" class="icon-title">
                <h1 class="header-title">Ben's Engineering Blog</h1>
                <img alt decoding="async" height="256" src="/media/icon.png.webp" width="256" draggable="true" fetchpriority="high">
                
            </a>
            <nav>
                <ul>
                    <li><a href="/posts">Posts</a></li>
                    <li><a href="/about">About</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <main>
        
        <div class="width-box">
            <style>.post{flex-direction:column;display:flex}.post>p,.post li,.post blockquote{line-height:1.6em;font-weight:inherit;margin:6px 0;font-family:Inter,Helvetica,sans-serif}.post>:is(h1,h2,h3,h4,h5){margin:12pt 0}.post img,.post video,.post pre:not(.shiki){margin:20px 0}.post pre.shiki{margin:0}:root:not(.dark) .post img.invertible,:root:not(.dark) .post video.invertible{filter:invert()}.post img{border-radius:10px}.post svg.icon{fill:var(--text-color);height:1em}.post span.line.highlight{background-color:var(--code-highlight);outline:4px var(--code-highlight)solid;font-weight:700}.post .shiki-container{padding:20px}.post .math{margin:auto}.post .math>svg{width:auto;height:200%;margin:10px}.post .quote{font-style:italic}.post .quote:before,.post .quote:after{content:"\""}.post [role=caption]{text-align:center;opacity:.8;margin:6px 0 20px;padding:6px;font-size:14px;font-weight:400}.post .date{margin-top:0;font-family:monospace;font-size:11pt}.post .center{text-align:center;font-weight:inherit;padding:30px}.post .note{opacity:.8;font-size:12pt;font-style:italic}:is(h1,h2,h3,h4,h5,h6)>code{font-size:.8em}:is(h1,h2,h3,h4,h5,h6,p,li)>code{padding:2px 6px}.post a[href^=\#foot]{font-family:monospace;position:relative;top:-5px;left:2px}.post #footnotes~*{width:100%;margin:4px 0;font-size:14px}video.small{max-height:300px!important}.callout{background-color:var(--muted-background);border:3px solid var(--muted-accent);border-radius:16px;margin-top:18px;padding:20px;font-size:15pt}.post h1.title{font-size:48px}.post h1{font-size:32px}.post h2{font-size:28px}.post h3{font-size:24px}.post h4{font-size:20px}.post h5{font-size:16px}.post a.media-container>img{width:100%}blockquote{border-left:4px solid var(--muted-accent);margin:10px 0;padding:0 10px}blockquote>p{margin:0}.discussions{margin:80px 0}.parralel pre:not(.shiki){font-size:12px}@media screen and (width<=480px){.center{text-align:center;font-weight:inherit;padding:10px 0}.post>p,.post li{font-size:12pt;line-height:1.4em}.post img,.post pre,.post video{width:100%;height:auto}.post pre{overflow-x:auto}}@media screen and (width>=480px){.post>.parralel{gap:30px;display:flex}.post>.parralel>div{flex-grow:1}.post img,.post video,.post pre:not(.shiki){align-self:center;max-width:100vw;height:auto;max-height:100vh}.post>img,.post>video,.post>a.media-container,.post>.parralel,.post>pre:not(.shiki){align-self:center;width:110%}}@media print{.post video{display:none}}</style>

<div class="post">
    <h1 class="title">My Rust infrastructure</h1>
    
    <p class="date">
        Published on Thursday 20<sup>th</sup> April 2023
        
    </p>
    
    <p>I have written a lot of Rust over the last couple of years. Along the way of building a <a href="https://github.com/kaleidawave/ezno">compiler</a>, I have built up a few smaller, generic crates and tools (infrastructure) to assist with writing Rust. I realised I haven't shared much about some of these, so I thought it would be a good opportunity to give an overview now.</p>
<p>If you are interested in getting started with Rust: Last summer I wrote a collection of posts for <a href="https://www.shuttle.rs/">Shuttle</a> (a great place to deploy Rust server applications). I wrote a bit about <a href="https://www.shuttle.rs/blog/2022/07/28/patterns-with-rust-types">patterns with Rust types</a>, <a href="https://www.shuttle.rs/blog/2022/06/30/error-handling">how Rust tackles error handling</a> or <a href="https://www.shuttle.rs/blog/2022/06/09/the-builder-pattern">the builder pattern</a> as <a href="https://www.shuttle.rs/blog/tags/all">well as many others</a>. If you are looking to get started with Rust, check those posts out as well as their platform (IMO currently the easiest way to deploy a Rust server application).</p>
<blockquote>
<p>This post was meant to part of an upcoming post about the parser I just published, but this stuff didn't fit into that post. So I decided to split the content up. Look forward to a future post which includes things I learned about parsing and talks about some parser utility libraries I have written (<a href="https://github.com/kaleidawave/source-map">source-map</a>, <a href="https://github.com/kaleidawave/tokenizer-lib">tokenizer-lib</a> and <a href="https://github.com/kaleidawave/derive-finite-automaton">derive-finite-automaton</a>) etc.</p>
</blockquote>
<p>I'll start off with a couple of libraries I've built that make it easier and shorter to write Rust code.</p>
<h2 id="building-macros-with-syn-helpers" tabindex="-1">Building macros with <a href="https://github.com/kaleidawave/syn-helpers">syn-helpers</a></h2>
<p>Proc(edural) macros are a way of generating Rust code. Derive proc macros are Rust's approach to reflection. I wrote at length about reflection, the use cases and an example with a comparison between vanilla JavaScript and Rust in <a href="https://www.shuttle.rs/blog/2022/12/23/procedural-macros">this post on Shuttle.rs</a>. In summary, proc derive macros allow for generating the Rust <code>impl</code> blocks based on the content of <code>struct</code> and <code>enum</code> declarations. For example, <code>#[derive(Debug)]</code> above a <code>struct</code> declaration finds fields and generates an <code>impl Debug for ...</code> with an implementation that prints the field name alongside its runtime value.</p>
<p>One thing about proc macros is that you will likely be reaching for the dependencies <code>syn</code> and <code>quote</code> when writing them. The <a href="https://doc.rust-lang.org/stable/proc_macro/">API</a> for writing them only gives us a low-level sequence of tokens. Fortunately <a href="https://github.com/dtolnay/syn">syn</a> exists and can parse the sequence into an <a href="https://docs.rs/syn/latest/syn/struct.DeriveInput.html">AST</a>, which makes it a lot easier to read fields. Generating output code is also made easier as <a href="https://github.com/dtolnay/quote">quote</a> offers a declarative using a macro: <a href="https://docs.rs/quote/latest/quote/macro.quote.html"><code>quote!</code></a> (<a href="https://docs.rs/syn/latest/syn/macro.parse_quote.html"><code>parse_quote!</code></a> is also a similar thing and equally useful).</p>
<p>But just these on their own, it can still be difficult and verbose to build actual proc macros (<a href="https://www.shuttle.rs/blog/2022/12/23/procedural-macros#procedural-macro-time">the code in the post only worked for structs with named fields</a>). Syn and quote offer great building blocks but they don't give you much help handling the setup required for derive proc macros.</p>
<p>Some of the problems I have run that make the code harder and longer to write and can also introduce bugs:</p>
<ul>
<li>Writing logic that can handle both <code>struct</code>s and <code>enum</code>s and their variants. You can use <code>self</code> to reference data in a <code>struct</code>, <strong>but not in</strong> an <code>enum</code></li>
<li>Creating expressions that access both named fields and unnamed fields</li>
<li>Handling generics that exist on either of the structure or the trait and how to handle if the names clash</li>
<li>How to handle attributes, how to access them at different levels</li>
<li>Forgetting to add <code>#[automatically_derived]</code></li>
</ul>
<p>To make this easier, last year I wrote a <em>'procedural macro framework'</em> that abstracted <code>syn</code> and this process to handle all these cases for you. It's a bit difficult to explain in words so here is an example that calls <code>do_thing</code> for all fields except ones marked with <code>ignore</code>.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#0d1117"><code><span class="line"><span style="color:#ff7b72">use</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">syn_helpers</span><span style="color:#ff7b72">::</span><span style="color:#c9d1d9">{</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ffa657">syn</span><span style="color:#ff7b72">::</span><span style="color:#c9d1d9">{parse_quote, </span><span style="color:#ffa657">DeriveInput</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">GenericParam</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Ident</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Stmt</span><span style="color:#c9d1d9">}, </span><span style="color:#ffa657">proc_macro2</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Span</span><span style="color:#c9d1d9">, quote,</span></span>
<span class="line"><span style="color:#c9d1d9">    derive_trait, </span><span style="color:#ffa657">FieldMut</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">HasAttributes</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Trait</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">TraitItem</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">TypeOfSelf</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Constructable</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> my_trait </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Trait</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">    name</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">my_crate</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">MyTrait</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">    generic_parameters</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">None</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">    items</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">vec!</span><span style="color:#c9d1d9">[</span><span style="color:#ffa657">TraitItem</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">new_method</span><span style="color:#c9d1d9">(</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">Ident</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">new</span><span style="color:#c9d1d9">(</span><span style="color:#a5d6ff">"method_one"</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Span</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">call_site</span><span style="color:#c9d1d9">()),</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">None</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">TypeOfSelf</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Reference</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">Vec</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">default</span><span style="color:#c9d1d9">(),</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">None</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ff7b72">|mut</span><span style="color:#c9d1d9"> item</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">            item</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">map_constructable</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">|mut</span><span style="color:#c9d1d9"> constructable</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">                </span><span style="color:#ffa657">Ok</span><span style="color:#c9d1d9">(constructable</span></span>
<span class="line"><span style="color:#c9d1d9">                    </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">get_fields_mut</span><span style="color:#c9d1d9">()</span></span>
<span class="line"><span style="color:#c9d1d9">                    </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">fields_iterator_mut</span><span style="color:#c9d1d9">()</span></span>
<span class="line"><span style="color:#c9d1d9">                    </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">flat_map</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">|mut</span><span style="color:#c9d1d9"> field</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">-&gt;</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Option</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">Stmt</span><span style="color:#c9d1d9">&gt; {</span></span>
<span class="line"><span style="color:#c9d1d9">                        </span><span style="color:#ff7b72">if</span><span style="color:#c9d1d9"> field</span></span>
<span class="line"><span style="color:#c9d1d9">                            </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">get_attributes</span><span style="color:#c9d1d9">()</span></span>
<span class="line"><span style="color:#c9d1d9">                            </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">iter</span><span style="color:#c9d1d9">()</span></span>
<span class="line"><span style="color:#c9d1d9">                            </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">any</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9">attr</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9"> attr</span><span style="color:#ff7b72">.</span><span style="color:#c9d1d9">path</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">is_ident</span><span style="color:#c9d1d9">(</span><span style="color:#a5d6ff">"ignore"</span><span style="color:#c9d1d9">))</span></span>
<span class="line"><span style="color:#c9d1d9">                        {</span></span>
<span class="line"><span style="color:#c9d1d9">                            </span><span style="color:#ffa657">None</span></span>
<span class="line"><span style="color:#c9d1d9">                        } </span><span style="color:#ff7b72">else</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">                            </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> reference </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> field</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">get_reference</span><span style="color:#c9d1d9">();</span></span>
<span class="line"><span style="color:#c9d1d9">                            </span><span style="color:#ffa657">Some</span><span style="color:#c9d1d9">(</span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">(</span><span style="color:#d2a8ff">do_thing</span><span style="color:#c9d1d9">(#reference);))</span></span>
<span class="line"><span style="color:#c9d1d9">                        }</span></span>
<span class="line"><span style="color:#c9d1d9">                    })</span></span>
<span class="line"><span style="color:#c9d1d9">                    </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">collect</span><span style="color:#c9d1d9">())</span></span>
<span class="line"><span style="color:#c9d1d9">            })</span></span>
<span class="line"><span style="color:#c9d1d9">        },</span></span>
<span class="line"><span style="color:#c9d1d9">    )],</span></span>
<span class="line"><span style="color:#c9d1d9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> r#struct</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">DeriveInput</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">struct</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">X</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">        a</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">String</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">        b</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">i32</span></span>
<span class="line"><span style="color:#c9d1d9">    }</span></span>
<span class="line"><span style="color:#c9d1d9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> stream </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">derive_trait</span><span style="color:#c9d1d9">(r#struct, my_trait);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d2a8ff">assert_eq!</span><span style="color:#c9d1d9">(</span></span>
<span class="line"><span style="color:#c9d1d9">    stream</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">to_string</span><span style="color:#c9d1d9">(),</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#d2a8ff">quote!</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">        #[automatically_derived]</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ff7b72">impl</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">::</span><span style="color:#ffa657">my_crate</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">MyTrait</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">for</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">X</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">            </span><span style="color:#ff7b72">fn</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">method_one</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">&amp;</span><span style="color:#79c0ff">self</span><span style="color:#c9d1d9">) {</span></span>
<span class="line"><span style="color:#c9d1d9">                </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">X</span><span style="color:#c9d1d9"> { a</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">ref</span><span style="color:#c9d1d9"> _0, b</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">ref</span><span style="color:#c9d1d9"> _1 } </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#79c0ff">self</span><span style="color:#c9d1d9">;</span></span>
<span class="line"><span style="color:#c9d1d9">                </span><span style="color:#d2a8ff">do_thing</span><span style="color:#c9d1d9">(_0);</span></span>
<span class="line"><span style="color:#c9d1d9">                </span><span style="color:#d2a8ff">do_thing</span><span style="color:#c9d1d9">(_1);</span></span>
<span class="line"><span style="color:#c9d1d9">            }</span></span>
<span class="line"><span style="color:#c9d1d9">        }</span></span>
<span class="line"><span style="color:#c9d1d9">    }</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">to_string</span><span style="color:#c9d1d9">()</span></span>
<span class="line"><span style="color:#c9d1d9">)</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">use</span><span style="color:#24292f"> </span><span style="color:#953800">syn_helpers</span><span style="color:#cf222e">::</span><span style="color:#24292f">{</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">syn</span><span style="color:#cf222e">::</span><span style="color:#24292f">{parse_quote, </span><span style="color:#953800">DeriveInput</span><span style="color:#24292f">, </span><span style="color:#953800">GenericParam</span><span style="color:#24292f">, </span><span style="color:#953800">Ident</span><span style="color:#24292f">, </span><span style="color:#953800">Stmt</span><span style="color:#24292f">}, </span><span style="color:#953800">proc_macro2</span><span style="color:#cf222e">::</span><span style="color:#953800">Span</span><span style="color:#24292f">, quote,</span></span>
<span class="line"><span style="color:#24292f">    derive_trait, </span><span style="color:#953800">FieldMut</span><span style="color:#24292f">, </span><span style="color:#953800">HasAttributes</span><span style="color:#24292f">, </span><span style="color:#953800">Trait</span><span style="color:#24292f">, </span><span style="color:#953800">TraitItem</span><span style="color:#24292f">, </span><span style="color:#953800">TypeOfSelf</span><span style="color:#24292f">, </span><span style="color:#953800">Constructable</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> my_trait </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">Trait</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    name</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">(</span><span style="color:#cf222e">::</span><span style="color:#953800">my_crate</span><span style="color:#cf222e">::</span><span style="color:#953800">MyTrait</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">    generic_parameters</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">None</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    items</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#8250df">vec!</span><span style="color:#24292f">[</span><span style="color:#953800">TraitItem</span><span style="color:#cf222e">::</span><span style="color:#8250df">new_method</span><span style="color:#24292f">(</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">Ident</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#0a3069">"method_one"</span><span style="color:#24292f">, </span><span style="color:#953800">Span</span><span style="color:#cf222e">::</span><span style="color:#8250df">call_site</span><span style="color:#24292f">()),</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">None</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">TypeOfSelf</span><span style="color:#cf222e">::</span><span style="color:#953800">Reference</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">Vec</span><span style="color:#cf222e">::</span><span style="color:#8250df">default</span><span style="color:#24292f">(),</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">None</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">|mut</span><span style="color:#24292f"> item</span><span style="color:#cf222e">|</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">            item</span><span style="color:#cf222e">.</span><span style="color:#8250df">map_constructable</span><span style="color:#24292f">(</span><span style="color:#cf222e">|mut</span><span style="color:#24292f"> constructable</span><span style="color:#cf222e">|</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">                </span><span style="color:#953800">Ok</span><span style="color:#24292f">(constructable</span></span>
<span class="line"><span style="color:#24292f">                    </span><span style="color:#cf222e">.</span><span style="color:#8250df">get_fields_mut</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">                    </span><span style="color:#cf222e">.</span><span style="color:#8250df">fields_iterator_mut</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">                    </span><span style="color:#cf222e">.</span><span style="color:#8250df">flat_map</span><span style="color:#24292f">(</span><span style="color:#cf222e">|mut</span><span style="color:#24292f"> field</span><span style="color:#cf222e">|</span><span style="color:#24292f"> </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> </span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Stmt</span><span style="color:#24292f">&gt; {</span></span>
<span class="line"><span style="color:#24292f">                        </span><span style="color:#cf222e">if</span><span style="color:#24292f"> field</span></span>
<span class="line"><span style="color:#24292f">                            </span><span style="color:#cf222e">.</span><span style="color:#8250df">get_attributes</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">                            </span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">                            </span><span style="color:#cf222e">.</span><span style="color:#8250df">any</span><span style="color:#24292f">(</span><span style="color:#cf222e">|</span><span style="color:#24292f">attr</span><span style="color:#cf222e">|</span><span style="color:#24292f"> attr</span><span style="color:#cf222e">.</span><span style="color:#24292f">path</span><span style="color:#cf222e">.</span><span style="color:#8250df">is_ident</span><span style="color:#24292f">(</span><span style="color:#0a3069">"ignore"</span><span style="color:#24292f">))</span></span>
<span class="line"><span style="color:#24292f">                        {</span></span>
<span class="line"><span style="color:#24292f">                            </span><span style="color:#953800">None</span></span>
<span class="line"><span style="color:#24292f">                        } </span><span style="color:#cf222e">else</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">                            </span><span style="color:#cf222e">let</span><span style="color:#24292f"> reference </span><span style="color:#cf222e">=</span><span style="color:#24292f"> field</span><span style="color:#cf222e">.</span><span style="color:#8250df">get_reference</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#24292f">                            </span><span style="color:#953800">Some</span><span style="color:#24292f">(</span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">(</span><span style="color:#8250df">do_thing</span><span style="color:#24292f">(#reference);))</span></span>
<span class="line"><span style="color:#24292f">                        }</span></span>
<span class="line"><span style="color:#24292f">                    })</span></span>
<span class="line"><span style="color:#24292f">                    </span><span style="color:#cf222e">.</span><span style="color:#8250df">collect</span><span style="color:#24292f">())</span></span>
<span class="line"><span style="color:#24292f">            })</span></span>
<span class="line"><span style="color:#24292f">        },</span></span>
<span class="line"><span style="color:#24292f">    )],</span></span>
<span class="line"><span style="color:#24292f">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> r#struct</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">DeriveInput</span><span style="color:#24292f"> </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">struct</span><span style="color:#24292f"> </span><span style="color:#953800">X</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        a</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">String</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">        b</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">i32</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> stream </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#8250df">derive_trait</span><span style="color:#24292f">(r#struct, my_trait);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8250df">assert_eq!</span><span style="color:#24292f">(</span></span>
<span class="line"><span style="color:#24292f">    stream</span><span style="color:#cf222e">.</span><span style="color:#8250df">to_string</span><span style="color:#24292f">(),</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">quote!</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        #[automatically_derived]</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">impl</span><span style="color:#24292f"> </span><span style="color:#cf222e">::</span><span style="color:#953800">my_crate</span><span style="color:#cf222e">::</span><span style="color:#953800">MyTrait</span><span style="color:#24292f"> </span><span style="color:#cf222e">for</span><span style="color:#24292f"> </span><span style="color:#953800">X</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">method_one</span><span style="color:#24292f">(</span><span style="color:#cf222e">&amp;</span><span style="color:#0550ae">self</span><span style="color:#24292f">) {</span></span>
<span class="line"><span style="color:#24292f">                </span><span style="color:#cf222e">let</span><span style="color:#24292f"> </span><span style="color:#953800">X</span><span style="color:#24292f"> { a</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">ref</span><span style="color:#24292f"> _0, b</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">ref</span><span style="color:#24292f"> _1 } </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#0550ae">self</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#24292f">                </span><span style="color:#8250df">do_thing</span><span style="color:#24292f">(_0);</span></span>
<span class="line"><span style="color:#24292f">                </span><span style="color:#8250df">do_thing</span><span style="color:#24292f">(_1);</span></span>
<span class="line"><span style="color:#24292f">            }</span></span>
<span class="line"><span style="color:#24292f">        }</span></span>
<span class="line"><span style="color:#24292f">    }</span><span style="color:#cf222e">.</span><span style="color:#8250df">to_string</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">)</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Benefits of using the crate here</p>
<ul>
<li><code>map_constructable</code> handles both enums variants and <code>struct</code>-ures.</li>
<li>The code uses the <a href="https://docs.rs/syn-helpers/0.4.3/syn_helpers/trait.Field.html"><code>Field</code></a> trait which abstracts over generating expressions to access fields. Handling named and unnamed variants is automated away</li>
<li>For fields whose type contains generics, it can add necessary <code>where</code> clauses if the trait is called on that field</li>
<li>The macro also gets a structure. You get a more declarative code by laying out the <a href="https://docs.rs/syn-helpers/0.4.3/syn_helpers/struct.Trait.html"><code>Trait</code></a> with the items you need to implement. Those methods contain functions that handle generating the output.</li>
</ul>
<p>For example, in the parser, I currently have a way of <em>visiting nodes</em> (running a set of functions over them) and automating this implementation becomes quite simple using the <code>syn-helpers</code> library.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#0d1117"><code><span class="line"><span style="color:#ff7b72">use</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">proc_macro</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">TokenStream</span><span style="color:#c9d1d9">;</span></span>
<span class="line"><span style="color:#ff7b72">use</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">std</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">error</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Error</span><span style="color:#c9d1d9">;</span></span>
<span class="line"><span style="color:#ff7b72">use</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">string_cases</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">StringCasesExt</span><span style="color:#c9d1d9">;</span></span>
<span class="line"><span style="color:#ff7b72">use</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">syn_helpers</span><span style="color:#ff7b72">::</span><span style="color:#c9d1d9">{</span></span>
<span class="line"><span style="color:#c9d1d9">    derive_trait,</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ffa657">proc_macro2</span><span style="color:#ff7b72">::</span><span style="color:#c9d1d9">{</span><span style="color:#ffa657">Ident</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Span</span><span style="color:#c9d1d9">},</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ffa657">quote</span><span style="color:#ff7b72">::</span><span style="color:#c9d1d9">{</span><span style="color:#79c0ff">self</span><span style="color:#c9d1d9">, format_ident},</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ffa657">syn</span><span style="color:#ff7b72">::</span><span style="color:#c9d1d9">{parse_macro_input, parse_quote, </span><span style="color:#ffa657">DeriveInput</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Stmt</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ffa657">Constructable</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">FieldMut</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">HasAttributes</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">NamedOrUnnamedFieldMut</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">		</span><span style="color:#ffa657">Trait</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">TraitItem</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8b949e">/// On the top structure</span></span>
<span class="line"><span style="color:#ff7b72">const</span><span style="color:#c9d1d9"> </span><span style="color:#79c0ff">VISIT_SELF_NAME</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">&amp;</span><span style="color:#ffa657">str</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#a5d6ff">"visit_self"</span><span style="color:#c9d1d9">;</span></span>
<span class="line"><span style="color:#8b949e">/// Per field modifiers</span></span>
<span class="line"><span style="color:#ff7b72">const</span><span style="color:#c9d1d9"> </span><span style="color:#79c0ff">VISIT_SKIP_NAME</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">&amp;</span><span style="color:#ffa657">str</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#a5d6ff">"visit_skip_field"</span><span style="color:#c9d1d9">;</span></span>
<span class="line"><span style="color:#8b949e">/// Add to chain. Can be on item or a field</span></span>
<span class="line"><span style="color:#ff7b72">const</span><span style="color:#c9d1d9"> </span><span style="color:#79c0ff">VISIT_WITH_CHAIN_NAME</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">&amp;</span><span style="color:#ffa657">str</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#a5d6ff">"visit_with_chain"</span><span style="color:#c9d1d9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8b949e">/// Usage #[derive(Visitable)]</span></span>
<span class="line"><span style="color:#c9d1d9">#[proc_macro_derive(</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ffa657">Visitable</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">    attributes(visit_self, visit_skip_field, visit_custom_visit)</span></span>
<span class="line"><span style="color:#c9d1d9">)]</span></span>
<span class="line"><span style="color:#ff7b72">pub</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">fn</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">generate_visit_implementation</span><span style="color:#c9d1d9">(input</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">TokenStream</span><span style="color:#c9d1d9">) </span><span style="color:#ff7b72">-&gt;</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">TokenStream</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> input </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">parse_macro_input!</span><span style="color:#c9d1d9">(input </span><span style="color:#ff7b72">as</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">DeriveInput</span><span style="color:#c9d1d9">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> visit_item </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">TraitItem</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">new_method</span><span style="color:#c9d1d9">(</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">Ident</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">new</span><span style="color:#c9d1d9">(</span><span style="color:#a5d6ff">"visit"</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Span</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">call_site</span><span style="color:#c9d1d9">()),</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">Some</span><span style="color:#c9d1d9">(</span><span style="color:#d2a8ff">vec!</span><span style="color:#c9d1d9">[</span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">TData</span><span style="color:#c9d1d9">)]),</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">syn_helpers</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">TypeOfSelf</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Reference</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#d2a8ff">vec!</span><span style="color:#c9d1d9">[</span></span>
<span class="line"><span style="color:#c9d1d9">            </span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">(visitors</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">&amp;mut</span><span style="color:#c9d1d9"> (</span><span style="color:#ff7b72">impl</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">crate::</span><span style="color:#ffa657">visiting</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">VisitorReceiver</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">TData</span><span style="color:#c9d1d9">&gt; </span><span style="color:#ff7b72">+</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">?</span><span style="color:#ffa657">Sized</span><span style="color:#c9d1d9">)),</span></span>
<span class="line"><span style="color:#c9d1d9">            </span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">(data</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">&amp;mut</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">TData</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">            </span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">(settings</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">&amp;crate::</span><span style="color:#ffa657">VisitSettings</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">            </span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">(chain</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">&amp;mut</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">::</span><span style="color:#ffa657">temporary_annex</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Annex</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ff7b72">crate::</span><span style="color:#c9d1d9">visiting</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Chain</span><span style="color:#c9d1d9">&gt;),</span></span>
<span class="line"><span style="color:#c9d1d9">        ],</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">None</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9">item</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">generated_visit_item</span><span style="color:#c9d1d9">(item, </span><span style="color:#ffa657">VisitType</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Immutable</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> visit_mut_item </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">TraitItem</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">new_method</span><span style="color:#c9d1d9">(</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">Ident</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">new</span><span style="color:#c9d1d9">(</span><span style="color:#a5d6ff">"visit_mut"</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Span</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">call_site</span><span style="color:#c9d1d9">()),</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">Some</span><span style="color:#c9d1d9">(</span><span style="color:#d2a8ff">vec!</span><span style="color:#c9d1d9">[</span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">TData</span><span style="color:#c9d1d9">)]),</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">syn_helpers</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">TypeOfSelf</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">MutableReference</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#d2a8ff">vec!</span><span style="color:#c9d1d9">[</span></span>
<span class="line"><span style="color:#c9d1d9">            </span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">(visitors</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">&amp;mut</span><span style="color:#c9d1d9"> (</span><span style="color:#ff7b72">impl</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">crate::</span><span style="color:#ffa657">visiting</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">VisitorMutReceiver</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">TData</span><span style="color:#c9d1d9">&gt; </span><span style="color:#ff7b72">+</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">?</span><span style="color:#ffa657">Sized</span><span style="color:#c9d1d9">)),</span></span>
<span class="line"><span style="color:#c9d1d9">            </span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">(data</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">&amp;mut</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">TData</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">            </span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">(settings</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">&amp;crate::</span><span style="color:#ffa657">VisitSettings</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">            </span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">(chain</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">&amp;mut</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">::</span><span style="color:#ffa657">temporary_annex</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Annex</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ff7b72">crate::</span><span style="color:#c9d1d9">visiting</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Chain</span><span style="color:#c9d1d9">&gt;),</span></span>
<span class="line"><span style="color:#c9d1d9">        ],</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">None</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9">item</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">generated_visit_item</span><span style="color:#c9d1d9">(item, </span><span style="color:#ffa657">VisitType</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Mutable</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> visitable_trait </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Trait</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">        name</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">crate::</span><span style="color:#ffa657">visiting</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Visitable</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">        generic_parameters</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">None</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">        items</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">vec!</span><span style="color:#c9d1d9">[visit_item, visit_mut_item],</span></span>
<span class="line"><span style="color:#c9d1d9">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> output </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">derive_trait</span><span style="color:#c9d1d9">(input, visitable_trait);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    output</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">into</span><span style="color:#c9d1d9">()</span></span>
<span class="line"><span style="color:#c9d1d9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">#[derive(</span><span style="color:#ffa657">Clone</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Copy</span><span style="color:#c9d1d9">)]</span></span>
<span class="line"><span style="color:#ff7b72">enum</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">VisitType</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ffa657">Immutable</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ffa657">Mutable</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff7b72">fn</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">generated_visit_item</span><span style="color:#c9d1d9">(</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">mut</span><span style="color:#c9d1d9"> item</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">syn_helpers</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Item</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">    visit_type</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">VisitType</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">) </span><span style="color:#ff7b72">-&gt;</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Result</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">Vec</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">Stmt</span><span style="color:#c9d1d9">&gt;, </span><span style="color:#ffa657">Box</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ff7b72">dyn</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Error</span><span style="color:#c9d1d9">&gt;&gt; {</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> attributes </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> item</span><span style="color:#ff7b72">.</span><span style="color:#c9d1d9">structure</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">get_attributes</span><span style="color:#c9d1d9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> visit_self </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> attributes</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">iter</span><span style="color:#c9d1d9">()</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">any</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9">attr</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9"> attr</span><span style="color:#ff7b72">.</span><span style="color:#c9d1d9">path</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">is_ident</span><span style="color:#c9d1d9">(</span><span style="color:#79c0ff">VISIT_SELF_NAME</span><span style="color:#c9d1d9">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> visit_with_chain </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> attributes</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">iter</span><span style="color:#c9d1d9">()</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">find_map</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9">attr</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">        attr</span><span style="color:#ff7b72">.</span><span style="color:#c9d1d9">path</span></span>
<span class="line"><span style="color:#c9d1d9">            </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">is_ident</span><span style="color:#c9d1d9">(</span><span style="color:#79c0ff">VISIT_WITH_CHAIN_NAME</span><span style="color:#c9d1d9">)</span></span>
<span class="line"><span style="color:#c9d1d9">            </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">then_some</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">&amp;</span><span style="color:#c9d1d9">attr</span><span style="color:#ff7b72">.</span><span style="color:#c9d1d9">tokens)</span></span>
<span class="line"><span style="color:#c9d1d9">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">mut</span><span style="color:#c9d1d9"> lines </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Vec</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">new</span><span style="color:#c9d1d9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">if</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Some</span><span style="color:#c9d1d9">(expr_tokens) </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> visit_with_chain {</span></span>
<span class="line"><span style="color:#c9d1d9">        lines</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">push</span><span style="color:#c9d1d9">(</span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">( </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">mut</span><span style="color:#c9d1d9"> chain </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">&amp;mut</span><span style="color:#c9d1d9"> chain</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">push_annex</span><span style="color:#c9d1d9">(#expr_tokens); ))</span></span>
<span class="line"><span style="color:#c9d1d9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">if</span><span style="color:#c9d1d9"> visit_self {</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> struct_name_as_snake_case </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">&amp;</span><span style="color:#c9d1d9">item</span><span style="color:#ff7b72">.</span><span style="color:#c9d1d9">structure</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">get_name</span><span style="color:#c9d1d9">()</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">to_string</span><span style="color:#c9d1d9">()</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">to_snake_case</span><span style="color:#c9d1d9">();</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> mut_postfix </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">matches!</span><span style="color:#c9d1d9">(visit_type, </span><span style="color:#ffa657">VisitType</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Mutable</span><span style="color:#c9d1d9">)</span></span>
<span class="line"><span style="color:#c9d1d9">            </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">then_some</span><span style="color:#c9d1d9">(</span><span style="color:#a5d6ff">"_mut"</span><span style="color:#c9d1d9">)</span></span>
<span class="line"><span style="color:#c9d1d9">            </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">unwrap_or_default</span><span style="color:#c9d1d9">();</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> func_name </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">format_ident!</span><span style="color:#c9d1d9">(</span><span style="color:#a5d6ff">"visit_{}{}"</span><span style="color:#c9d1d9">, struct_name_as_snake_case, mut_postfix);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">        lines</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">push</span><span style="color:#c9d1d9">(</span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9">( visitors</span><span style="color:#ff7b72">.</span><span style="color:#c9d1d9">#</span><span style="color:#d2a8ff">func_name</span><span style="color:#c9d1d9">(</span><span style="color:#79c0ff">self</span><span style="color:#c9d1d9">, data,  chain); ))</span></span>
<span class="line"><span style="color:#c9d1d9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">mut</span><span style="color:#c9d1d9"> field_lines </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> item</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">map_constructable</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">|mut</span><span style="color:#c9d1d9"> constructable</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">Ok</span><span style="color:#c9d1d9">(constructable</span></span>
<span class="line"><span style="color:#c9d1d9">			</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">get_fields_mut</span><span style="color:#c9d1d9">()</span></span>
<span class="line"><span style="color:#c9d1d9">			</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">fields_iterator_mut</span><span style="color:#c9d1d9">()</span></span>
<span class="line"><span style="color:#c9d1d9">			</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">flat_map</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">|mut</span><span style="color:#c9d1d9"> field</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">NamedOrUnnamedFieldMut</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">-&gt;</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Option</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">Stmt</span><span style="color:#c9d1d9">&gt; {</span></span>
<span class="line"><span style="color:#c9d1d9">				</span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> attributes </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> field</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">get_attributes</span><span style="color:#c9d1d9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">				</span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> skip_field </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> attributes</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">iter</span><span style="color:#c9d1d9">()</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">any</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9">attr</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9"> attr</span><span style="color:#ff7b72">.</span><span style="color:#c9d1d9">path</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">is_ident</span><span style="color:#c9d1d9">(</span><span style="color:#79c0ff">VISIT_SKIP_NAME</span><span style="color:#c9d1d9">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">				</span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> visit_with_chain </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> attributes</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">iter</span><span style="color:#c9d1d9">()</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">find_map</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9">attr</span><span style="color:#ff7b72">|</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">					attr</span><span style="color:#ff7b72">.</span><span style="color:#c9d1d9">path</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">is_ident</span><span style="color:#c9d1d9">(</span><span style="color:#79c0ff">VISIT_WITH_CHAIN_NAME</span><span style="color:#c9d1d9">)</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">then_some</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">&amp;</span><span style="color:#c9d1d9">attr</span><span style="color:#ff7b72">.</span><span style="color:#c9d1d9">tokens)</span></span>
<span class="line"><span style="color:#c9d1d9">				});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">				</span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> chain </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">if</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Some</span><span style="color:#c9d1d9">(expr_tokens) </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> visit_with_chain {</span></span>
<span class="line"><span style="color:#c9d1d9">					</span><span style="color:#d2a8ff">quote!</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">&amp;mut</span><span style="color:#c9d1d9"> chain</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">push_annex</span><span style="color:#c9d1d9">(#expr_tokens))</span></span>
<span class="line"><span style="color:#c9d1d9">				} </span><span style="color:#ff7b72">else</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">					</span><span style="color:#d2a8ff">quote!</span><span style="color:#c9d1d9">(chain)</span></span>
<span class="line"><span style="color:#c9d1d9">				};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">				</span><span style="color:#ff7b72">if</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">!</span><span style="color:#c9d1d9">skip_field {</span></span>
<span class="line"><span style="color:#c9d1d9">					</span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> reference </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> field</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">get_reference</span><span style="color:#c9d1d9">();</span></span>
<span class="line"><span style="color:#c9d1d9">					</span><span style="color:#ffa657">Some</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">match</span><span style="color:#c9d1d9"> visit_type {</span></span>
<span class="line"><span style="color:#c9d1d9">						</span><span style="color:#ffa657">VisitType</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Immutable</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">=&gt;</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">							</span><span style="color:#ff7b72">crate::</span><span style="color:#ffa657">Visitable</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">visit</span><span style="color:#c9d1d9">(#reference, visitors, data, settings, #chain);</span></span>
<span class="line"><span style="color:#c9d1d9">						},</span></span>
<span class="line"><span style="color:#c9d1d9">						</span><span style="color:#ffa657">VisitType</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Mutable</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">=&gt;</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">parse_quote!</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">							</span><span style="color:#ff7b72">crate::</span><span style="color:#ffa657">Visitable</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">visit_mut</span><span style="color:#c9d1d9">(#reference, visitors, data, settings, #chain);</span></span>
<span class="line"><span style="color:#c9d1d9">						},</span></span>
<span class="line"><span style="color:#c9d1d9">					})</span></span>
<span class="line"><span style="color:#c9d1d9">				} </span><span style="color:#ff7b72">else</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">					</span><span style="color:#ffa657">None</span></span>
<span class="line"><span style="color:#c9d1d9">				}</span></span>
<span class="line"><span style="color:#c9d1d9">			})</span></span>
<span class="line"><span style="color:#c9d1d9">			</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">collect</span><span style="color:#ff7b72">::</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">Vec</span><span style="color:#c9d1d9">&lt;_&gt;&gt;())</span></span>
<span class="line"><span style="color:#c9d1d9">    })</span><span style="color:#ff7b72">?</span><span style="color:#c9d1d9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    lines</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">append</span><span style="color:#c9d1d9">(</span><span style="color:#ff7b72">&amp;mut</span><span style="color:#c9d1d9"> field_lines);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ffa657">Ok</span><span style="color:#c9d1d9">(lines)</span></span>
<span class="line"><span style="color:#c9d1d9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">use</span><span style="color:#24292f"> </span><span style="color:#953800">proc_macro</span><span style="color:#cf222e">::</span><span style="color:#953800">TokenStream</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#cf222e">use</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#cf222e">::</span><span style="color:#953800">error</span><span style="color:#cf222e">::</span><span style="color:#953800">Error</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#cf222e">use</span><span style="color:#24292f"> </span><span style="color:#953800">string_cases</span><span style="color:#cf222e">::</span><span style="color:#953800">StringCasesExt</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#cf222e">use</span><span style="color:#24292f"> </span><span style="color:#953800">syn_helpers</span><span style="color:#cf222e">::</span><span style="color:#24292f">{</span></span>
<span class="line"><span style="color:#24292f">    derive_trait,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">proc_macro2</span><span style="color:#cf222e">::</span><span style="color:#24292f">{</span><span style="color:#953800">Ident</span><span style="color:#24292f">, </span><span style="color:#953800">Span</span><span style="color:#24292f">},</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">quote</span><span style="color:#cf222e">::</span><span style="color:#24292f">{</span><span style="color:#0550ae">self</span><span style="color:#24292f">, format_ident},</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">syn</span><span style="color:#cf222e">::</span><span style="color:#24292f">{parse_macro_input, parse_quote, </span><span style="color:#953800">DeriveInput</span><span style="color:#24292f">, </span><span style="color:#953800">Stmt</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">Constructable</span><span style="color:#24292f">, </span><span style="color:#953800">FieldMut</span><span style="color:#24292f">, </span><span style="color:#953800">HasAttributes</span><span style="color:#24292f">, </span><span style="color:#953800">NamedOrUnnamedFieldMut</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">		</span><span style="color:#953800">Trait</span><span style="color:#24292f">, </span><span style="color:#953800">TraitItem</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6e7781">/// On the top structure</span></span>
<span class="line"><span style="color:#cf222e">const</span><span style="color:#24292f"> </span><span style="color:#0550ae">VISIT_SELF_NAME</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#953800">str</span><span style="color:#24292f"> </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#0a3069">"visit_self"</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#6e7781">/// Per field modifiers</span></span>
<span class="line"><span style="color:#cf222e">const</span><span style="color:#24292f"> </span><span style="color:#0550ae">VISIT_SKIP_NAME</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#953800">str</span><span style="color:#24292f"> </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#0a3069">"visit_skip_field"</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#6e7781">/// Add to chain. Can be on item or a field</span></span>
<span class="line"><span style="color:#cf222e">const</span><span style="color:#24292f"> </span><span style="color:#0550ae">VISIT_WITH_CHAIN_NAME</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#953800">str</span><span style="color:#24292f"> </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#0a3069">"visit_with_chain"</span><span style="color:#24292f">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6e7781">/// Usage #[derive(Visitable)]</span></span>
<span class="line"><span style="color:#24292f">#[proc_macro_derive(</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">Visitable</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    attributes(visit_self, visit_skip_field, visit_custom_visit)</span></span>
<span class="line"><span style="color:#24292f">)]</span></span>
<span class="line"><span style="color:#cf222e">pub</span><span style="color:#24292f"> </span><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">generate_visit_implementation</span><span style="color:#24292f">(input</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">TokenStream</span><span style="color:#24292f">) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> </span><span style="color:#953800">TokenStream</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> input </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#8250df">parse_macro_input!</span><span style="color:#24292f">(input </span><span style="color:#cf222e">as</span><span style="color:#24292f"> </span><span style="color:#953800">DeriveInput</span><span style="color:#24292f">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> visit_item </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">TraitItem</span><span style="color:#cf222e">::</span><span style="color:#8250df">new_method</span><span style="color:#24292f">(</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">Ident</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#0a3069">"visit"</span><span style="color:#24292f">, </span><span style="color:#953800">Span</span><span style="color:#cf222e">::</span><span style="color:#8250df">call_site</span><span style="color:#24292f">()),</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">Some</span><span style="color:#24292f">(</span><span style="color:#8250df">vec!</span><span style="color:#24292f">[</span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">(</span><span style="color:#953800">TData</span><span style="color:#24292f">)]),</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">syn_helpers</span><span style="color:#cf222e">::</span><span style="color:#953800">TypeOfSelf</span><span style="color:#cf222e">::</span><span style="color:#953800">Reference</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#8250df">vec!</span><span style="color:#24292f">[</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">(visitors</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> (</span><span style="color:#cf222e">impl</span><span style="color:#24292f"> </span><span style="color:#cf222e">crate::</span><span style="color:#953800">visiting</span><span style="color:#cf222e">::</span><span style="color:#953800">VisitorReceiver</span><span style="color:#24292f">&lt;</span><span style="color:#953800">TData</span><span style="color:#24292f">&gt; </span><span style="color:#cf222e">+</span><span style="color:#24292f"> </span><span style="color:#cf222e">?</span><span style="color:#953800">Sized</span><span style="color:#24292f">)),</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">(data</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> </span><span style="color:#953800">TData</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">(settings</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;crate::</span><span style="color:#953800">VisitSettings</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">(chain</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> </span><span style="color:#cf222e">::</span><span style="color:#953800">temporary_annex</span><span style="color:#cf222e">::</span><span style="color:#953800">Annex</span><span style="color:#24292f">&lt;</span><span style="color:#cf222e">crate::</span><span style="color:#24292f">visiting</span><span style="color:#cf222e">::</span><span style="color:#953800">Chain</span><span style="color:#24292f">&gt;),</span></span>
<span class="line"><span style="color:#24292f">        ],</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">None</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">|</span><span style="color:#24292f">item</span><span style="color:#cf222e">|</span><span style="color:#24292f"> </span><span style="color:#8250df">generated_visit_item</span><span style="color:#24292f">(item, </span><span style="color:#953800">VisitType</span><span style="color:#cf222e">::</span><span style="color:#953800">Immutable</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> visit_mut_item </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">TraitItem</span><span style="color:#cf222e">::</span><span style="color:#8250df">new_method</span><span style="color:#24292f">(</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">Ident</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#0a3069">"visit_mut"</span><span style="color:#24292f">, </span><span style="color:#953800">Span</span><span style="color:#cf222e">::</span><span style="color:#8250df">call_site</span><span style="color:#24292f">()),</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">Some</span><span style="color:#24292f">(</span><span style="color:#8250df">vec!</span><span style="color:#24292f">[</span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">(</span><span style="color:#953800">TData</span><span style="color:#24292f">)]),</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">syn_helpers</span><span style="color:#cf222e">::</span><span style="color:#953800">TypeOfSelf</span><span style="color:#cf222e">::</span><span style="color:#953800">MutableReference</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#8250df">vec!</span><span style="color:#24292f">[</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">(visitors</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> (</span><span style="color:#cf222e">impl</span><span style="color:#24292f"> </span><span style="color:#cf222e">crate::</span><span style="color:#953800">visiting</span><span style="color:#cf222e">::</span><span style="color:#953800">VisitorMutReceiver</span><span style="color:#24292f">&lt;</span><span style="color:#953800">TData</span><span style="color:#24292f">&gt; </span><span style="color:#cf222e">+</span><span style="color:#24292f"> </span><span style="color:#cf222e">?</span><span style="color:#953800">Sized</span><span style="color:#24292f">)),</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">(data</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> </span><span style="color:#953800">TData</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">(settings</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;crate::</span><span style="color:#953800">VisitSettings</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">(chain</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> </span><span style="color:#cf222e">::</span><span style="color:#953800">temporary_annex</span><span style="color:#cf222e">::</span><span style="color:#953800">Annex</span><span style="color:#24292f">&lt;</span><span style="color:#cf222e">crate::</span><span style="color:#24292f">visiting</span><span style="color:#cf222e">::</span><span style="color:#953800">Chain</span><span style="color:#24292f">&gt;),</span></span>
<span class="line"><span style="color:#24292f">        ],</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">None</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">|</span><span style="color:#24292f">item</span><span style="color:#cf222e">|</span><span style="color:#24292f"> </span><span style="color:#8250df">generated_visit_item</span><span style="color:#24292f">(item, </span><span style="color:#953800">VisitType</span><span style="color:#cf222e">::</span><span style="color:#953800">Mutable</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> visitable_trait </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">Trait</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        name</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">(</span><span style="color:#cf222e">crate::</span><span style="color:#953800">visiting</span><span style="color:#cf222e">::</span><span style="color:#953800">Visitable</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">        generic_parameters</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">None</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">        items</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#8250df">vec!</span><span style="color:#24292f">[visit_item, visit_mut_item],</span></span>
<span class="line"><span style="color:#24292f">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> output </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#8250df">derive_trait</span><span style="color:#24292f">(input, visitable_trait);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    output</span><span style="color:#cf222e">.</span><span style="color:#8250df">into</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">#[derive(</span><span style="color:#953800">Clone</span><span style="color:#24292f">, </span><span style="color:#953800">Copy</span><span style="color:#24292f">)]</span></span>
<span class="line"><span style="color:#cf222e">enum</span><span style="color:#24292f"> </span><span style="color:#953800">VisitType</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">Immutable</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">Mutable</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">generated_visit_item</span><span style="color:#24292f">(</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">mut</span><span style="color:#24292f"> item</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">syn_helpers</span><span style="color:#cf222e">::</span><span style="color:#953800">Item</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    visit_type</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">VisitType</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> </span><span style="color:#953800">Result</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Vec</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Stmt</span><span style="color:#24292f">&gt;, </span><span style="color:#953800">Box</span><span style="color:#24292f">&lt;</span><span style="color:#cf222e">dyn</span><span style="color:#24292f"> </span><span style="color:#953800">Error</span><span style="color:#24292f">&gt;&gt; {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> attributes </span><span style="color:#cf222e">=</span><span style="color:#24292f"> item</span><span style="color:#cf222e">.</span><span style="color:#24292f">structure</span><span style="color:#cf222e">.</span><span style="color:#8250df">get_attributes</span><span style="color:#24292f">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> visit_self </span><span style="color:#cf222e">=</span><span style="color:#24292f"> attributes</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">.</span><span style="color:#8250df">any</span><span style="color:#24292f">(</span><span style="color:#cf222e">|</span><span style="color:#24292f">attr</span><span style="color:#cf222e">|</span><span style="color:#24292f"> attr</span><span style="color:#cf222e">.</span><span style="color:#24292f">path</span><span style="color:#cf222e">.</span><span style="color:#8250df">is_ident</span><span style="color:#24292f">(</span><span style="color:#0550ae">VISIT_SELF_NAME</span><span style="color:#24292f">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> visit_with_chain </span><span style="color:#cf222e">=</span><span style="color:#24292f"> attributes</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">find_map</span><span style="color:#24292f">(</span><span style="color:#cf222e">|</span><span style="color:#24292f">attr</span><span style="color:#cf222e">|</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        attr</span><span style="color:#cf222e">.</span><span style="color:#24292f">path</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#cf222e">.</span><span style="color:#8250df">is_ident</span><span style="color:#24292f">(</span><span style="color:#0550ae">VISIT_WITH_CHAIN_NAME</span><span style="color:#24292f">)</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#cf222e">.</span><span style="color:#8250df">then_some</span><span style="color:#24292f">(</span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">attr</span><span style="color:#cf222e">.</span><span style="color:#24292f">tokens)</span></span>
<span class="line"><span style="color:#24292f">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> </span><span style="color:#cf222e">mut</span><span style="color:#24292f"> lines </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">Vec</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">if</span><span style="color:#24292f"> </span><span style="color:#cf222e">let</span><span style="color:#24292f"> </span><span style="color:#953800">Some</span><span style="color:#24292f">(expr_tokens) </span><span style="color:#cf222e">=</span><span style="color:#24292f"> visit_with_chain {</span></span>
<span class="line"><span style="color:#24292f">        lines</span><span style="color:#cf222e">.</span><span style="color:#8250df">push</span><span style="color:#24292f">(</span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">( </span><span style="color:#cf222e">let</span><span style="color:#24292f"> </span><span style="color:#cf222e">mut</span><span style="color:#24292f"> chain </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> chain</span><span style="color:#cf222e">.</span><span style="color:#8250df">push_annex</span><span style="color:#24292f">(#expr_tokens); ))</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">if</span><span style="color:#24292f"> visit_self {</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">let</span><span style="color:#24292f"> struct_name_as_snake_case </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">item</span><span style="color:#cf222e">.</span><span style="color:#24292f">structure</span><span style="color:#cf222e">.</span><span style="color:#8250df">get_name</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">to_string</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">to_snake_case</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">let</span><span style="color:#24292f"> mut_postfix </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#8250df">matches!</span><span style="color:#24292f">(visit_type, </span><span style="color:#953800">VisitType</span><span style="color:#cf222e">::</span><span style="color:#953800">Mutable</span><span style="color:#24292f">)</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#cf222e">.</span><span style="color:#8250df">then_some</span><span style="color:#24292f">(</span><span style="color:#0a3069">"_mut"</span><span style="color:#24292f">)</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#cf222e">.</span><span style="color:#8250df">unwrap_or_default</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">let</span><span style="color:#24292f"> func_name </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#8250df">format_ident!</span><span style="color:#24292f">(</span><span style="color:#0a3069">"visit_{}{}"</span><span style="color:#24292f">, struct_name_as_snake_case, mut_postfix);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">        lines</span><span style="color:#cf222e">.</span><span style="color:#8250df">push</span><span style="color:#24292f">(</span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f">( visitors</span><span style="color:#cf222e">.</span><span style="color:#24292f">#</span><span style="color:#8250df">func_name</span><span style="color:#24292f">(</span><span style="color:#0550ae">self</span><span style="color:#24292f">, data,  chain); ))</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> </span><span style="color:#cf222e">mut</span><span style="color:#24292f"> field_lines </span><span style="color:#cf222e">=</span><span style="color:#24292f"> item</span><span style="color:#cf222e">.</span><span style="color:#8250df">map_constructable</span><span style="color:#24292f">(</span><span style="color:#cf222e">|mut</span><span style="color:#24292f"> constructable</span><span style="color:#cf222e">|</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">Ok</span><span style="color:#24292f">(constructable</span></span>
<span class="line"><span style="color:#24292f">			</span><span style="color:#cf222e">.</span><span style="color:#8250df">get_fields_mut</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">			</span><span style="color:#cf222e">.</span><span style="color:#8250df">fields_iterator_mut</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">			</span><span style="color:#cf222e">.</span><span style="color:#8250df">flat_map</span><span style="color:#24292f">(</span><span style="color:#cf222e">|mut</span><span style="color:#24292f"> field</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">NamedOrUnnamedFieldMut</span><span style="color:#cf222e">|</span><span style="color:#24292f"> </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> </span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Stmt</span><span style="color:#24292f">&gt; {</span></span>
<span class="line"><span style="color:#24292f">				</span><span style="color:#cf222e">let</span><span style="color:#24292f"> attributes </span><span style="color:#cf222e">=</span><span style="color:#24292f"> field</span><span style="color:#cf222e">.</span><span style="color:#8250df">get_attributes</span><span style="color:#24292f">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">				</span><span style="color:#cf222e">let</span><span style="color:#24292f"> skip_field </span><span style="color:#cf222e">=</span><span style="color:#24292f"> attributes</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">any</span><span style="color:#24292f">(</span><span style="color:#cf222e">|</span><span style="color:#24292f">attr</span><span style="color:#cf222e">|</span><span style="color:#24292f"> attr</span><span style="color:#cf222e">.</span><span style="color:#24292f">path</span><span style="color:#cf222e">.</span><span style="color:#8250df">is_ident</span><span style="color:#24292f">(</span><span style="color:#0550ae">VISIT_SKIP_NAME</span><span style="color:#24292f">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">				</span><span style="color:#cf222e">let</span><span style="color:#24292f"> visit_with_chain </span><span style="color:#cf222e">=</span><span style="color:#24292f"> attributes</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">find_map</span><span style="color:#24292f">(</span><span style="color:#cf222e">|</span><span style="color:#24292f">attr</span><span style="color:#cf222e">|</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">					attr</span><span style="color:#cf222e">.</span><span style="color:#24292f">path</span><span style="color:#cf222e">.</span><span style="color:#8250df">is_ident</span><span style="color:#24292f">(</span><span style="color:#0550ae">VISIT_WITH_CHAIN_NAME</span><span style="color:#24292f">)</span><span style="color:#cf222e">.</span><span style="color:#8250df">then_some</span><span style="color:#24292f">(</span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">attr</span><span style="color:#cf222e">.</span><span style="color:#24292f">tokens)</span></span>
<span class="line"><span style="color:#24292f">				});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">				</span><span style="color:#cf222e">let</span><span style="color:#24292f"> chain </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">if</span><span style="color:#24292f"> </span><span style="color:#cf222e">let</span><span style="color:#24292f"> </span><span style="color:#953800">Some</span><span style="color:#24292f">(expr_tokens) </span><span style="color:#cf222e">=</span><span style="color:#24292f"> visit_with_chain {</span></span>
<span class="line"><span style="color:#24292f">					</span><span style="color:#8250df">quote!</span><span style="color:#24292f">(</span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> chain</span><span style="color:#cf222e">.</span><span style="color:#8250df">push_annex</span><span style="color:#24292f">(#expr_tokens))</span></span>
<span class="line"><span style="color:#24292f">				} </span><span style="color:#cf222e">else</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">					</span><span style="color:#8250df">quote!</span><span style="color:#24292f">(chain)</span></span>
<span class="line"><span style="color:#24292f">				};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">				</span><span style="color:#cf222e">if</span><span style="color:#24292f"> </span><span style="color:#cf222e">!</span><span style="color:#24292f">skip_field {</span></span>
<span class="line"><span style="color:#24292f">					</span><span style="color:#cf222e">let</span><span style="color:#24292f"> reference </span><span style="color:#cf222e">=</span><span style="color:#24292f"> field</span><span style="color:#cf222e">.</span><span style="color:#8250df">get_reference</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#24292f">					</span><span style="color:#953800">Some</span><span style="color:#24292f">(</span><span style="color:#cf222e">match</span><span style="color:#24292f"> visit_type {</span></span>
<span class="line"><span style="color:#24292f">						</span><span style="color:#953800">VisitType</span><span style="color:#cf222e">::</span><span style="color:#953800">Immutable</span><span style="color:#24292f"> </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> </span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">							</span><span style="color:#cf222e">crate::</span><span style="color:#953800">Visitable</span><span style="color:#cf222e">::</span><span style="color:#8250df">visit</span><span style="color:#24292f">(#reference, visitors, data, settings, #chain);</span></span>
<span class="line"><span style="color:#24292f">						},</span></span>
<span class="line"><span style="color:#24292f">						</span><span style="color:#953800">VisitType</span><span style="color:#cf222e">::</span><span style="color:#953800">Mutable</span><span style="color:#24292f"> </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> </span><span style="color:#8250df">parse_quote!</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">							</span><span style="color:#cf222e">crate::</span><span style="color:#953800">Visitable</span><span style="color:#cf222e">::</span><span style="color:#8250df">visit_mut</span><span style="color:#24292f">(#reference, visitors, data, settings, #chain);</span></span>
<span class="line"><span style="color:#24292f">						},</span></span>
<span class="line"><span style="color:#24292f">					})</span></span>
<span class="line"><span style="color:#24292f">				} </span><span style="color:#cf222e">else</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">					</span><span style="color:#953800">None</span></span>
<span class="line"><span style="color:#24292f">				}</span></span>
<span class="line"><span style="color:#24292f">			})</span></span>
<span class="line"><span style="color:#24292f">			</span><span style="color:#cf222e">.</span><span style="color:#8250df">collect</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Vec</span><span style="color:#24292f">&lt;_&gt;&gt;())</span></span>
<span class="line"><span style="color:#24292f">    })</span><span style="color:#cf222e">?</span><span style="color:#24292f">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    lines</span><span style="color:#cf222e">.</span><span style="color:#8250df">append</span><span style="color:#24292f">(</span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> field_lines);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">Ok</span><span style="color:#24292f">(lines)</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>It takes around 140 lines to implement this trait. <code>syn-helpers</code> here can handle the cases when the AST contains generics. Using <code>syn-helpers</code> means the code can focus on the actual behaviour of the trait rather than handling all the different cases Rust declarations can be in.</p>
<hr>
<p>Although it is called <code>syn-helpers</code> and that was its original aim, it has now grown into a large framework focused on derive macros. So if you write derive macros and maybe struggle with keeping things concise. If you have API/abstraction you want to be added for a proc-macro you are writing I am open <a href="https://github.com/kaleidawave/syn-helpers/issues">for discussion</a>.</p>
<p>Building this out I feel it might be close to a fully declarative macro implementation <a href="https://github.com/kaleidawave/syn-helpers/issues/1">notes here</a>. Rust current has declarative macros but anything <code>derive</code> based has to be done imperatively and there isn't an end-to-end declarative approach. Maybe it could be tried out in this library.</p>
<h3 id="putting-the-framework-to-build-more-customisable-derive-implementations" tabindex="-1">Putting the framework to build more customisable <code>derive</code> implementations</h3>
<p>I had written two macros before, and <code>syn-helpers</code> <em>helped</em> tidy up and share the code between these two. The two main ones are:</p>
<h3 id="%23%5Bderive(debugextras)%5D" tabindex="-1"><code>#[derive(DebugExtras)]</code></h3>
<p><code>#[derive(Debug)]</code> is great most times, but sometimes it lacks a bit of customisation for the derive item. <a href="https://github.com/kaleidawave/derive-debug-extras">derive-debug-extras</a> offers an enhanced macro that adds <code>#[debug_ignore]</code> and <code>#[debug_as_display]</code> attributes that can help improve debugging.</p>
<p>But arguably my favourite one is <a href="https://github.com/kaleidawave/derive-debug-extras#debug_single_tuple_inline"><code>#[debug_single_tuple_inline]</code></a>. This fixes a problem in the Ezno checker. I use a lot of the new type pattern to declare identifiers. Unfortunately, despite them only having one field, when debugging them with the pretty flag (I want other named structs to be over lines) it ends up over three. So although it did require rewriting the standard debug implementation, now:</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#0d1117"><code><span class="line"><span style="color:#8b949e">// Without #[debug_single_tuple_inline]</span></span>
<span class="line"><span style="color:#c9d1d9">[</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#d2a8ff">A</span><span style="color:#c9d1d9">(</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#79c0ff">123</span></span>
<span class="line"><span style="color:#c9d1d9">    ),</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#d2a8ff">A</span><span style="color:#c9d1d9">(</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#79c0ff">145</span></span>
<span class="line"><span style="color:#c9d1d9">    ),</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#d2a8ff">A</span><span style="color:#c9d1d9">(</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#79c0ff">125</span></span>
<span class="line"><span style="color:#c9d1d9">    ),</span></span>
<span class="line"><span style="color:#c9d1d9">]</span></span>
<span class="line"><span style="color:#8b949e">// With #[debug_single_tuple_inline]</span></span>
<span class="line"><span style="color:#c9d1d9">[</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#d2a8ff">A</span><span style="color:#c9d1d9">(</span><span style="color:#79c0ff">123</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#d2a8ff">A</span><span style="color:#c9d1d9">(</span><span style="color:#79c0ff">145</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#d2a8ff">A</span><span style="color:#c9d1d9">(</span><span style="color:#79c0ff">125</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">]</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#6e7781">// Without #[debug_single_tuple_inline]</span></span>
<span class="line"><span style="color:#24292f">[</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">A</span><span style="color:#24292f">(</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#0550ae">123</span></span>
<span class="line"><span style="color:#24292f">    ),</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">A</span><span style="color:#24292f">(</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#0550ae">145</span></span>
<span class="line"><span style="color:#24292f">    ),</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">A</span><span style="color:#24292f">(</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#0550ae">125</span></span>
<span class="line"><span style="color:#24292f">    ),</span></span>
<span class="line"><span style="color:#24292f">]</span></span>
<span class="line"><span style="color:#6e7781">// With #[debug_single_tuple_inline]</span></span>
<span class="line"><span style="color:#24292f">[</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">A</span><span style="color:#24292f">(</span><span style="color:#0550ae">123</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">A</span><span style="color:#24292f">(</span><span style="color:#0550ae">145</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">A</span><span style="color:#24292f">(</span><span style="color:#0550ae">125</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">]</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>IMO, all unnamed fields when debugged should be on one line despite the pretty flag.</p>
<h3 id="%23%5Bderive(partialeqextras)%5D" tabindex="-1"><code>#[derive(PartialEqExtras)]</code></h3>
<p>In a similar vein, <a href="https://github.com/kaleidawave/derive-partial-eq-extras">derive-partial-eq-extras</a> adds a more customisable <a href="https://doc.rust-lang.org/std/cmp/trait.PartialEq.html">PartialEq</a> implementation. It adds two new attributes for ignoring certain fields in the implementer.</p>
<p>For example, in my parser, expressions have positions and IDs. However, when comparing two expressions I want to treat them on a value basis and not based on position or identifiers. For example, given the literal expression <code>5</code>, I want AST to equal other <code>5</code>s, no matter where they have been parsed. To do this I simply add <code>#[partial_eq_ignore_types]</code>, which I can use easily on the expression AST:</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#0d1117"><code><span class="line"><span style="color:#c9d1d9">#[derive(</span><span style="color:#ffa657">PartialEqExtras</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Debug</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Clone</span><span style="color:#c9d1d9">)]</span></span>
<span class="line"><span style="color:#c9d1d9">#[partial_eq_ignore_types(</span><span style="color:#ffa657">Span</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">ExpressionId</span><span style="color:#c9d1d9">)]</span></span>
<span class="line"><span style="color:#ff7b72">pub</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">enum</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Expression</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">NumberLiteral</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">NumberStructure</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Span</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">ExpressionId</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">StringLiteral</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">String</span><span style="color:#c9d1d9">, #[partial_eq_ignore] </span><span style="color:#ffa657">Quoted</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Span</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">ExpressionId</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">BooleanLiteral</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">bool</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Span</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">ExpressionId</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#ffa657">RegexLiteral</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">		pattern</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">String</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">		flags</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Option</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">String</span><span style="color:#c9d1d9">&gt;,</span></span>
<span class="line"><span style="color:#c9d1d9">		position</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Span</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">		id</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">ExpressionId</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">	},</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">ArrayLiteral</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">Vec</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">SpreadExpression</span><span style="color:#c9d1d9">&gt;, </span><span style="color:#ffa657">Span</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">ExpressionId</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">ObjectLiteral</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">ObjectLiteral</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#ff7b72">...</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">#[derive(</span><span style="color:#953800">PartialEqExtras</span><span style="color:#24292f">, </span><span style="color:#953800">Debug</span><span style="color:#24292f">, </span><span style="color:#953800">Clone</span><span style="color:#24292f">)]</span></span>
<span class="line"><span style="color:#24292f">#[partial_eq_ignore_types(</span><span style="color:#953800">Span</span><span style="color:#24292f">, </span><span style="color:#953800">ExpressionId</span><span style="color:#24292f">)]</span></span>
<span class="line"><span style="color:#cf222e">pub</span><span style="color:#24292f"> </span><span style="color:#cf222e">enum</span><span style="color:#24292f"> </span><span style="color:#953800">Expression</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">NumberLiteral</span><span style="color:#24292f">(</span><span style="color:#953800">NumberStructure</span><span style="color:#24292f">, </span><span style="color:#953800">Span</span><span style="color:#24292f">, </span><span style="color:#953800">ExpressionId</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">StringLiteral</span><span style="color:#24292f">(</span><span style="color:#953800">String</span><span style="color:#24292f">, #[partial_eq_ignore] </span><span style="color:#953800">Quoted</span><span style="color:#24292f">, </span><span style="color:#953800">Span</span><span style="color:#24292f">, </span><span style="color:#953800">ExpressionId</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">BooleanLiteral</span><span style="color:#24292f">(</span><span style="color:#953800">bool</span><span style="color:#24292f">, </span><span style="color:#953800">Span</span><span style="color:#24292f">, </span><span style="color:#953800">ExpressionId</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#953800">RegexLiteral</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">		pattern</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">String</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">		flags</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">String</span><span style="color:#24292f">&gt;,</span></span>
<span class="line"><span style="color:#24292f">		position</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Span</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">		id</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">ExpressionId</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">	},</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">ArrayLiteral</span><span style="color:#24292f">(</span><span style="color:#953800">Vec</span><span style="color:#24292f">&lt;</span><span style="color:#953800">SpreadExpression</span><span style="color:#24292f">&gt;, </span><span style="color:#953800">Span</span><span style="color:#24292f">, </span><span style="color:#953800">ExpressionId</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">ObjectLiteral</span><span style="color:#24292f">(</span><span style="color:#953800">ObjectLiteral</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#cf222e">...</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>This is similar to <a href="https://docs.rs/educe/latest/educe/#ignore-fields-1">educe</a>, however it does not have the <em>ignore types</em> feature, so declarations can get clobbered with annotations on lots of fields. I did try and add it to educe but got a bit scared by its codebase.</p>
</blockquote>
<p>Again look into the sources and see that they are slim as they are built of <code>syn-helpers</code></p>
<h2 id="assisting-with-sum-enums" tabindex="-1">Assisting with sum <code>enum</code>s</h2>
<p>In the parser, I often have types that sum together some struct definitions like</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#0d1117"><code><span class="line"><span style="color:#c9d1d9">#[derive(</span><span style="color:#ffa657">Debug</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Clone</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">PartialEq</span><span style="color:#c9d1d9">)]</span></span>
<span class="line"><span style="color:#ff7b72">pub</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">enum</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Declaration</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">Variable</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">VariableDeclaration</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">Function</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">Decorated</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">StatementFunction</span><span style="color:#c9d1d9">&gt;),</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">Class</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">Decorated</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">ClassDeclaration</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">StatementPosition</span><span style="color:#c9d1d9">&gt;&gt;),</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">Enum</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">Decorated</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">EnumDeclaration</span><span style="color:#c9d1d9">&gt;),</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#ff7b72">...</span></span>
<span class="line"><span style="color:#c9d1d9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">#[derive(</span><span style="color:#953800">Debug</span><span style="color:#24292f">, </span><span style="color:#953800">Clone</span><span style="color:#24292f">, </span><span style="color:#953800">PartialEq</span><span style="color:#24292f">)]</span></span>
<span class="line"><span style="color:#cf222e">pub</span><span style="color:#24292f"> </span><span style="color:#cf222e">enum</span><span style="color:#24292f"> </span><span style="color:#953800">Declaration</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">Variable</span><span style="color:#24292f">(</span><span style="color:#953800">VariableDeclaration</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">Function</span><span style="color:#24292f">(</span><span style="color:#953800">Decorated</span><span style="color:#24292f">&lt;</span><span style="color:#953800">StatementFunction</span><span style="color:#24292f">&gt;),</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">Class</span><span style="color:#24292f">(</span><span style="color:#953800">Decorated</span><span style="color:#24292f">&lt;</span><span style="color:#953800">ClassDeclaration</span><span style="color:#24292f">&lt;</span><span style="color:#953800">StatementPosition</span><span style="color:#24292f">&gt;&gt;),</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">Enum</span><span style="color:#24292f">(</span><span style="color:#953800">Decorated</span><span style="color:#24292f">&lt;</span><span style="color:#953800">EnumDeclaration</span><span style="color:#24292f">&gt;),</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#cf222e">...</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Converting in and out can be a bit of a pain. If I have a function that takes a <code>Declaration</code> I need to remember the variant and then wrap the whole expression in it. So I created <a href="https://github.com/kaleidawave/derive-enum-from-into">derive enum from into</a>. With this, I can add <code>#[derive(EnumFrom, EnumTryInto)]</code> to have an easier time converting between the two (including immutable and mutable references).</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#0d1117"><code><span class="line"><span style="color:#c9d1d9">#[derive(</span><span style="color:#ffa657">Debug</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">Clone</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">EnumFrom</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">EnumTryInto</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">PartialEq</span><span style="color:#c9d1d9">)]</span></span>
<span class="line"><span style="color:#c9d1d9">#[try_into_references(</span><span style="color:#ff7b72">&amp;</span><span style="color:#c9d1d9">, </span><span style="color:#ff7b72">&amp;mut</span><span style="color:#c9d1d9">)]</span></span>
<span class="line"><span style="color:#ff7b72">pub</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">enum</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Declaration</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">Variable</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">VariableDeclaration</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">Function</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">Decorated</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">StatementFunction</span><span style="color:#c9d1d9">&gt;),</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">Class</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">Decorated</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">ClassDeclaration</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">StatementPosition</span><span style="color:#c9d1d9">&gt;&gt;),</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">Enum</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">Decorated</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">EnumDeclaration</span><span style="color:#c9d1d9">&gt;),</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#ff7b72">...</span></span>
<span class="line"><span style="color:#c9d1d9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff7b72">fn</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">my_func</span><span style="color:#c9d1d9">(var_dec</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">VariableDeclaration</span><span style="color:#c9d1d9">) {</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> dec </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Declaration</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">from</span><span style="color:#c9d1d9">(var_dec);</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">assert!</span><span style="color:#c9d1d9">(</span><span style="color:#d2a8ff">matches!</span><span style="color:#c9d1d9">(dec, </span><span style="color:#ffa657">Declaration</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">Variable</span><span style="color:#c9d1d9">(_)));</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#ff7b72">let</span><span style="color:#c9d1d9"> result </span><span style="color:#ff7b72">=</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Decorated</span><span style="color:#ff7b72">::</span><span style="color:#c9d1d9">&lt;</span><span style="color:#ffa657">StatementFunction</span><span style="color:#c9d1d9">&gt;</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">try_from</span><span style="color:#c9d1d9">(dec);</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#d2a8ff">assert!</span><span style="color:#c9d1d9">(result</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">is_err</span><span style="color:#c9d1d9">());</span></span>
<span class="line"><span style="color:#c9d1d9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">#[derive(</span><span style="color:#953800">Debug</span><span style="color:#24292f">, </span><span style="color:#953800">Clone</span><span style="color:#24292f">, </span><span style="color:#953800">EnumFrom</span><span style="color:#24292f">, </span><span style="color:#953800">EnumTryInto</span><span style="color:#24292f">, </span><span style="color:#953800">PartialEq</span><span style="color:#24292f">)]</span></span>
<span class="line"><span style="color:#24292f">#[try_into_references(</span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">, </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f">)]</span></span>
<span class="line"><span style="color:#cf222e">pub</span><span style="color:#24292f"> </span><span style="color:#cf222e">enum</span><span style="color:#24292f"> </span><span style="color:#953800">Declaration</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">Variable</span><span style="color:#24292f">(</span><span style="color:#953800">VariableDeclaration</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">Function</span><span style="color:#24292f">(</span><span style="color:#953800">Decorated</span><span style="color:#24292f">&lt;</span><span style="color:#953800">StatementFunction</span><span style="color:#24292f">&gt;),</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">Class</span><span style="color:#24292f">(</span><span style="color:#953800">Decorated</span><span style="color:#24292f">&lt;</span><span style="color:#953800">ClassDeclaration</span><span style="color:#24292f">&lt;</span><span style="color:#953800">StatementPosition</span><span style="color:#24292f">&gt;&gt;),</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">Enum</span><span style="color:#24292f">(</span><span style="color:#953800">Decorated</span><span style="color:#24292f">&lt;</span><span style="color:#953800">EnumDeclaration</span><span style="color:#24292f">&gt;),</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#cf222e">...</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">my_func</span><span style="color:#24292f">(var_dec</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">VariableDeclaration</span><span style="color:#24292f">) {</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#cf222e">let</span><span style="color:#24292f"> dec </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">Declaration</span><span style="color:#cf222e">::</span><span style="color:#8250df">from</span><span style="color:#24292f">(var_dec);</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">assert!</span><span style="color:#24292f">(</span><span style="color:#8250df">matches!</span><span style="color:#24292f">(dec, </span><span style="color:#953800">Declaration</span><span style="color:#cf222e">::</span><span style="color:#8250df">Variable</span><span style="color:#24292f">(_)));</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#cf222e">let</span><span style="color:#24292f"> result </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">Decorated</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">StatementFunction</span><span style="color:#24292f">&gt;</span><span style="color:#cf222e">::</span><span style="color:#8250df">try_from</span><span style="color:#24292f">(dec);</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#8250df">assert!</span><span style="color:#24292f">(result</span><span style="color:#cf222e">.</span><span style="color:#8250df">is_err</span><span style="color:#24292f">());</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>This is a smaller, less configurable, <code>enum</code> only version of <a href="https://jeltef.github.io/derive_more/derive_more/from.html">#[derive(From)] from the derive_more crate</a></p>
</blockquote>
<p>This crate is actually my most downloaded, possibly because it seems to be used on this <a href="https://github.com/near/nearcore/blob/02bd5996d0e581f12768baa9f3f68849a77a8312/Cargo.toml#L121">popular project</a>.</p>
<h2 id="iterator-endiate" tabindex="-1">Iterator endiate</h2>
<p>A smaller one, but I often have a case when iterating through something I want to know if it is the last one. This often happens in the to-string part of my parser where I want to add a comma delimiter between items but don't want a trailing comma. For <a href="https://doc.rust-lang.org/stable/std/iter/trait.ExactSizeIterator.html">iterators with a known size</a>, this crate adds an <a href="http://xion.io/post/code/rust-extension-traits.html">extension trait</a> that adds the <code>endiate</code> method. Similar in functionality to the <code>enumerate</code>.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#0d1117"><code><span class="line"><span style="color:#8b949e">// adds `.endiate()` method to all (sized) iterators</span></span>
<span class="line"><span style="color:#ff7b72">use</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">iterator_endiate</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">EndiateIteratorExt</span><span style="color:#c9d1d9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff7b72">for</span><span style="color:#c9d1d9"> (at_end, item) </span><span style="color:#ff7b72">in</span><span style="color:#c9d1d9"> items</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">iter</span><span style="color:#c9d1d9">()</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">endiate</span><span style="color:#c9d1d9">() {</span></span>
<span class="line"><span style="color:#c9d1d9">	settings</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">add_indent</span><span style="color:#c9d1d9">(depth, buf);</span></span>
<span class="line"><span style="color:#c9d1d9">	item</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">to_string_from_buffer</span><span style="color:#c9d1d9">(buf, settings, depth);</span></span>
<span class="line"><span style="color:#c9d1d9">	</span><span style="color:#ff7b72">if</span><span style="color:#c9d1d9"> </span><span style="color:#ff7b72">!</span><span style="color:#c9d1d9">at_end {</span></span>
<span class="line"><span style="color:#c9d1d9">		</span><span style="color:#ff7b72">if</span><span style="color:#c9d1d9"> item</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">requires_semi_colon</span><span style="color:#c9d1d9">() {</span></span>
<span class="line"><span style="color:#c9d1d9">			buf</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">push</span><span style="color:#c9d1d9">(</span><span style="color:#a5d6ff">';'</span><span style="color:#c9d1d9">);</span></span>
<span class="line"><span style="color:#c9d1d9">		}</span></span>
<span class="line"><span style="color:#c9d1d9">		</span><span style="color:#ff7b72">if</span><span style="color:#c9d1d9"> settings</span><span style="color:#ff7b72">.</span><span style="color:#c9d1d9">pretty {</span></span>
<span class="line"><span style="color:#c9d1d9">			buf</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">push_new_line</span><span style="color:#c9d1d9">();</span></span>
<span class="line"><span style="color:#c9d1d9">		}</span></span>
<span class="line"><span style="color:#c9d1d9">	}</span></span>
<span class="line"><span style="color:#c9d1d9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#6e7781">// adds `.endiate()` method to all (sized) iterators</span></span>
<span class="line"><span style="color:#cf222e">use</span><span style="color:#24292f"> </span><span style="color:#953800">iterator_endiate</span><span style="color:#cf222e">::</span><span style="color:#953800">EndiateIteratorExt</span><span style="color:#24292f">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">for</span><span style="color:#24292f"> (at_end, item) </span><span style="color:#cf222e">in</span><span style="color:#24292f"> items</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">endiate</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">	settings</span><span style="color:#cf222e">.</span><span style="color:#8250df">add_indent</span><span style="color:#24292f">(depth, buf);</span></span>
<span class="line"><span style="color:#24292f">	item</span><span style="color:#cf222e">.</span><span style="color:#8250df">to_string_from_buffer</span><span style="color:#24292f">(buf, settings, depth);</span></span>
<span class="line"><span style="color:#24292f">	</span><span style="color:#cf222e">if</span><span style="color:#24292f"> </span><span style="color:#cf222e">!</span><span style="color:#24292f">at_end {</span></span>
<span class="line"><span style="color:#24292f">		</span><span style="color:#cf222e">if</span><span style="color:#24292f"> item</span><span style="color:#cf222e">.</span><span style="color:#8250df">requires_semi_colon</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">			buf</span><span style="color:#cf222e">.</span><span style="color:#8250df">push</span><span style="color:#24292f">(</span><span style="color:#0a3069">';'</span><span style="color:#24292f">);</span></span>
<span class="line"><span style="color:#24292f">		}</span></span>
<span class="line"><span style="color:#24292f">		</span><span style="color:#cf222e">if</span><span style="color:#24292f"> settings</span><span style="color:#cf222e">.</span><span style="color:#24292f">pretty {</span></span>
<span class="line"><span style="color:#24292f">			buf</span><span style="color:#cf222e">.</span><span style="color:#8250df">push_new_line</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#24292f">		}</span></span>
<span class="line"><span style="color:#24292f">	}</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Also adds the <code>nendiate</code> for when you want to know you are not at the end</p>
<h2 id="enums-and-strings" tabindex="-1">Enums and strings</h2>
<p><a href="https://github.com/kaleidawave/enum-variants-strings">Enum variants strings</a> is a library for converting between (yes, both ways) <code>&amp;str</code> and <code>enum</code> structures. The derive macro handles generating this based on variant names. Mapping from a string to an <code>enum</code>, works for simple things that implement <a href="https://doc.rust-lang.org/stable/std/default/trait.Default.html"><code>Default</code></a>.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#0d1117"><code><span class="line"><span style="color:#ff7b72">use</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">enum_variants_strings</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">EnumVariantsStrings</span><span style="color:#c9d1d9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">#[derive(</span><span style="color:#ffa657">Debug</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">PartialEq</span><span style="color:#c9d1d9">, </span><span style="color:#ffa657">EnumVariantsStrings</span><span style="color:#c9d1d9">)]</span></span>
<span class="line"><span style="color:#ff7b72">enum</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">Variants</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ffa657">X</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#d2a8ff">Y</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">i32</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">    #[enum_variants_strings_mappings(</span><span style="color:#a5d6ff">"z"</span><span style="color:#c9d1d9">, </span><span style="color:#a5d6ff">"zee"</span><span style="color:#c9d1d9">)]</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#ffa657">Z</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">        x</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">String</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">        y</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">String</span><span style="color:#c9d1d9">,</span></span>
<span class="line"><span style="color:#c9d1d9">    },</span></span>
<span class="line"><span style="color:#c9d1d9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff7b72">fn</span><span style="color:#c9d1d9"> </span><span style="color:#d2a8ff">main</span><span style="color:#c9d1d9">() {</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#d2a8ff">assert_eq!</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">Variants</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">from_str</span><span style="color:#c9d1d9">(</span><span style="color:#a5d6ff">"x"</span><span style="color:#c9d1d9">), </span><span style="color:#ffa657">Ok</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">Variants</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">X</span><span style="color:#c9d1d9">));</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#d2a8ff">assert_eq!</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">Variants</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">from_str</span><span style="color:#c9d1d9">(</span><span style="color:#a5d6ff">"y"</span><span style="color:#c9d1d9">), </span><span style="color:#ffa657">Ok</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">Variants</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">Y</span><span style="color:#c9d1d9">(</span><span style="color:#79c0ff">0</span><span style="color:#c9d1d9">)));</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#d2a8ff">assert_eq!</span><span style="color:#c9d1d9">(</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">Variants</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">from_str</span><span style="color:#c9d1d9">(</span><span style="color:#a5d6ff">"z"</span><span style="color:#c9d1d9">),</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">Ok</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">Variants</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Z</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">            x</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">String</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">default</span><span style="color:#c9d1d9">(),</span></span>
<span class="line"><span style="color:#c9d1d9">            y</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#ffa657">String</span><span style="color:#ff7b72">::</span><span style="color:#d2a8ff">default</span><span style="color:#c9d1d9">(),</span></span>
<span class="line"><span style="color:#c9d1d9">        })</span></span>
<span class="line"><span style="color:#c9d1d9">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#d2a8ff">assert_eq!</span><span style="color:#c9d1d9">(</span><span style="color:#ffa657">Variants</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">X</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">to_str</span><span style="color:#c9d1d9">(), </span><span style="color:#a5d6ff">"x"</span><span style="color:#c9d1d9">);</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#d2a8ff">assert_eq!</span><span style="color:#c9d1d9">(</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ffa657">Variants</span><span style="color:#ff7b72">::</span><span style="color:#ffa657">Z</span><span style="color:#c9d1d9"> {</span></span>
<span class="line"><span style="color:#c9d1d9">            x</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#a5d6ff">"abc"</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">into</span><span style="color:#c9d1d9">(),</span></span>
<span class="line"><span style="color:#c9d1d9">            y</span><span style="color:#ff7b72">:</span><span style="color:#c9d1d9"> </span><span style="color:#a5d6ff">"xyz"</span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">into</span><span style="color:#c9d1d9">()</span></span>
<span class="line"><span style="color:#c9d1d9">        }</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#ff7b72">.</span><span style="color:#d2a8ff">to_str</span><span style="color:#c9d1d9">(),</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#a5d6ff">"zee"</span></span>
<span class="line"><span style="color:#c9d1d9">    );</span></span>
<span class="line"><span style="color:#c9d1d9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">use</span><span style="color:#24292f"> </span><span style="color:#953800">enum_variants_strings</span><span style="color:#cf222e">::</span><span style="color:#953800">EnumVariantsStrings</span><span style="color:#24292f">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">#[derive(</span><span style="color:#953800">Debug</span><span style="color:#24292f">, </span><span style="color:#953800">PartialEq</span><span style="color:#24292f">, </span><span style="color:#953800">EnumVariantsStrings</span><span style="color:#24292f">)]</span></span>
<span class="line"><span style="color:#cf222e">enum</span><span style="color:#24292f"> </span><span style="color:#953800">Variants</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">X</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">Y</span><span style="color:#24292f">(</span><span style="color:#953800">i32</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">    #[enum_variants_strings_mappings(</span><span style="color:#0a3069">"z"</span><span style="color:#24292f">, </span><span style="color:#0a3069">"zee"</span><span style="color:#24292f">)]</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">Z</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        x</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">String</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">        y</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">String</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    },</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">main</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">assert_eq!</span><span style="color:#24292f">(</span><span style="color:#953800">Variants</span><span style="color:#cf222e">::</span><span style="color:#8250df">from_str</span><span style="color:#24292f">(</span><span style="color:#0a3069">"x"</span><span style="color:#24292f">), </span><span style="color:#953800">Ok</span><span style="color:#24292f">(</span><span style="color:#953800">Variants</span><span style="color:#cf222e">::</span><span style="color:#953800">X</span><span style="color:#24292f">));</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">assert_eq!</span><span style="color:#24292f">(</span><span style="color:#953800">Variants</span><span style="color:#cf222e">::</span><span style="color:#8250df">from_str</span><span style="color:#24292f">(</span><span style="color:#0a3069">"y"</span><span style="color:#24292f">), </span><span style="color:#953800">Ok</span><span style="color:#24292f">(</span><span style="color:#953800">Variants</span><span style="color:#cf222e">::</span><span style="color:#8250df">Y</span><span style="color:#24292f">(</span><span style="color:#0550ae">0</span><span style="color:#24292f">)));</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">assert_eq!</span><span style="color:#24292f">(</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">Variants</span><span style="color:#cf222e">::</span><span style="color:#8250df">from_str</span><span style="color:#24292f">(</span><span style="color:#0a3069">"z"</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">Ok</span><span style="color:#24292f">(</span><span style="color:#953800">Variants</span><span style="color:#cf222e">::</span><span style="color:#953800">Z</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">            x</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">String</span><span style="color:#cf222e">::</span><span style="color:#8250df">default</span><span style="color:#24292f">(),</span></span>
<span class="line"><span style="color:#24292f">            y</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">String</span><span style="color:#cf222e">::</span><span style="color:#8250df">default</span><span style="color:#24292f">(),</span></span>
<span class="line"><span style="color:#24292f">        })</span></span>
<span class="line"><span style="color:#24292f">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">assert_eq!</span><span style="color:#24292f">(</span><span style="color:#953800">Variants</span><span style="color:#cf222e">::</span><span style="color:#953800">X</span><span style="color:#cf222e">.</span><span style="color:#8250df">to_str</span><span style="color:#24292f">(), </span><span style="color:#0a3069">"x"</span><span style="color:#24292f">);</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">assert_eq!</span><span style="color:#24292f">(</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">Variants</span><span style="color:#cf222e">::</span><span style="color:#953800">Z</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">            x</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#0a3069">"abc"</span><span style="color:#cf222e">.</span><span style="color:#8250df">into</span><span style="color:#24292f">(),</span></span>
<span class="line"><span style="color:#24292f">            y</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#0a3069">"xyz"</span><span style="color:#cf222e">.</span><span style="color:#8250df">into</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">        }</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">.</span><span style="color:#8250df">to_str</span><span style="color:#24292f">(),</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#0a3069">"zee"</span></span>
<span class="line"><span style="color:#24292f">    );</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p><a href="https://github.com/kaleidawave/ezno/blob/75d31ddb60eee495915fcf805a56221d2e79ce7d/src/ast_explorer.rs#L40">I use it for changing between modes in the ast-playground of Ezno</a>.</p>
<h2 id="deploying-rust-with-github-actions" tabindex="-1">Deploying Rust with GitHub actions</h2>
<p>In my crates, I want the update commit to automatically push the version change back to the repository. If I do it manually, I always forget to push after, things get out of sync.</p>
<p>So I built a GitHub action for doing this: <a href="https://github.com/kaleidawave/crates-release-gh-action">crates-release-action</a></p>
<p>Here is how you can use it:</p>
<pre><code class="language-yaml"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#0d1117"><code><span class="line"><span style="color:#7ee787">name</span><span style="color:#c9d1d9">: </span><span style="color:#a5d6ff">Release crate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79c0ff">on</span><span style="color:#c9d1d9">:</span></span>
<span class="line"><span style="color:#c9d1d9">  </span><span style="color:#7ee787">workflow_dispatch</span><span style="color:#c9d1d9">:</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#7ee787">inputs</span><span style="color:#c9d1d9">:</span></span>
<span class="line"><span style="color:#c9d1d9">      </span><span style="color:#7ee787">version</span><span style="color:#c9d1d9">:</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#7ee787">description</span><span style="color:#c9d1d9">: </span><span style="color:#a5d6ff">"major/minor/patch or semver"</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#7ee787">required</span><span style="color:#c9d1d9">: </span><span style="color:#79c0ff">false</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#7ee787">default</span><span style="color:#c9d1d9">: </span><span style="color:#a5d6ff">"patch"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7ee787">concurrency</span><span style="color:#c9d1d9">: </span><span style="color:#a5d6ff">release-crate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7ee787">jobs</span><span style="color:#c9d1d9">:</span></span>
<span class="line"><span style="color:#c9d1d9">  </span><span style="color:#7ee787">publish</span><span style="color:#c9d1d9">:</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#7ee787">runs-on</span><span style="color:#c9d1d9">: </span><span style="color:#a5d6ff">ubuntu-latest</span></span>
<span class="line"><span style="color:#c9d1d9">    </span><span style="color:#7ee787">steps</span><span style="color:#c9d1d9">:</span></span>
<span class="line"><span style="color:#c9d1d9">      - </span><span style="color:#7ee787">uses</span><span style="color:#c9d1d9">: </span><span style="color:#a5d6ff">actions/checkout@v3</span></span>
<span class="line"><span style="color:#c9d1d9">      - </span><span style="color:#7ee787">name</span><span style="color:#c9d1d9">: </span><span style="color:#a5d6ff">Set git credentials</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#7ee787">run</span><span style="color:#c9d1d9">: </span><span style="color:#ff7b72">|</span></span>
<span class="line"><span style="color:#a5d6ff">          git config user.name github-actions</span></span>
<span class="line"><span style="color:#a5d6ff">          git config user.email github-actions@github.com</span></span>
<span class="line"><span style="color:#c9d1d9">      - </span><span style="color:#7ee787">name</span><span style="color:#c9d1d9">: </span><span style="color:#a5d6ff">Crates publish</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#7ee787">uses</span><span style="color:#c9d1d9">: </span><span style="color:#a5d6ff">kaleidawave/crates-release-gh-action@main</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#7ee787">id</span><span style="color:#c9d1d9">: </span><span style="color:#a5d6ff">release</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#7ee787">with</span><span style="color:#c9d1d9">:</span></span>
<span class="line"><span style="color:#c9d1d9">          </span><span style="color:#7ee787">version</span><span style="color:#c9d1d9">: </span><span style="color:#a5d6ff">$</span></span>
<span class="line"><span style="color:#c9d1d9">          </span><span style="color:#7ee787">crates-token</span><span style="color:#c9d1d9">: </span><span style="color:#a5d6ff">$</span></span>
<span class="line"><span style="color:#c9d1d9">      - </span><span style="color:#7ee787">name</span><span style="color:#c9d1d9">: </span><span style="color:#a5d6ff">Push updated Cargo.toml</span></span>
<span class="line"><span style="color:#c9d1d9">        </span><span style="color:#7ee787">run</span><span style="color:#c9d1d9">: </span><span style="color:#ff7b72">|</span></span>
<span class="line"><span style="color:#a5d6ff">          git add .</span></span>
<span class="line"><span style="color:#a5d6ff">          git commit -m "Release: $"</span></span>
<span class="line"><span style="color:#a5d6ff">          git tag "release/$"</span></span>
<span class="line"><span style="color:#a5d6ff">          git push --tags origin main</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#116329">name</span><span style="color:#24292f">: </span><span style="color:#0a3069">Release crate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#0550ae">on</span><span style="color:#24292f">:</span></span>
<span class="line"><span style="color:#24292f">  </span><span style="color:#116329">workflow_dispatch</span><span style="color:#24292f">:</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#116329">inputs</span><span style="color:#24292f">:</span></span>
<span class="line"><span style="color:#24292f">      </span><span style="color:#116329">version</span><span style="color:#24292f">:</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#116329">description</span><span style="color:#24292f">: </span><span style="color:#0a3069">"major/minor/patch or semver"</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#116329">required</span><span style="color:#24292f">: </span><span style="color:#0550ae">false</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#116329">default</span><span style="color:#24292f">: </span><span style="color:#0a3069">"patch"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#116329">concurrency</span><span style="color:#24292f">: </span><span style="color:#0a3069">release-crate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#116329">jobs</span><span style="color:#24292f">:</span></span>
<span class="line"><span style="color:#24292f">  </span><span style="color:#116329">publish</span><span style="color:#24292f">:</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#116329">runs-on</span><span style="color:#24292f">: </span><span style="color:#0a3069">ubuntu-latest</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#116329">steps</span><span style="color:#24292f">:</span></span>
<span class="line"><span style="color:#24292f">      - </span><span style="color:#116329">uses</span><span style="color:#24292f">: </span><span style="color:#0a3069">actions/checkout@v3</span></span>
<span class="line"><span style="color:#24292f">      - </span><span style="color:#116329">name</span><span style="color:#24292f">: </span><span style="color:#0a3069">Set git credentials</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#116329">run</span><span style="color:#24292f">: </span><span style="color:#cf222e">|</span></span>
<span class="line"><span style="color:#0a3069">          git config user.name github-actions</span></span>
<span class="line"><span style="color:#0a3069">          git config user.email github-actions@github.com</span></span>
<span class="line"><span style="color:#24292f">      - </span><span style="color:#116329">name</span><span style="color:#24292f">: </span><span style="color:#0a3069">Crates publish</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#116329">uses</span><span style="color:#24292f">: </span><span style="color:#0a3069">kaleidawave/crates-release-gh-action@main</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#116329">id</span><span style="color:#24292f">: </span><span style="color:#0a3069">release</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#116329">with</span><span style="color:#24292f">:</span></span>
<span class="line"><span style="color:#24292f">          </span><span style="color:#116329">version</span><span style="color:#24292f">: </span><span style="color:#0a3069">$</span></span>
<span class="line"><span style="color:#24292f">          </span><span style="color:#116329">crates-token</span><span style="color:#24292f">: </span><span style="color:#0a3069">$</span></span>
<span class="line"><span style="color:#24292f">      - </span><span style="color:#116329">name</span><span style="color:#24292f">: </span><span style="color:#0a3069">Push updated Cargo.toml</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#116329">run</span><span style="color:#24292f">: </span><span style="color:#cf222e">|</span></span>
<span class="line"><span style="color:#0a3069">          git add .</span></span>
<span class="line"><span style="color:#0a3069">          git commit -m "Release: $"</span></span>
<span class="line"><span style="color:#0a3069">          git tag "release/$"</span></span>
<span class="line"><span style="color:#0a3069">          git push --tags origin main</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>It handles:</p>
<ul>
<li>Finding manifests</li>
<li>Applying <code>major</code>, <code>minor</code> or <code>patch</code> to a version (or an exact version) and updating the contents of <code>Cargo.toml</code></li>
<li>Finding local manifests that reference it as a path dependency to update their version</li>
<li>Publishing to <a href="https://crates.io/">crates.io</a></li>
<li>Outputting the new version(s) in a machine-readable format (so it can be referenced in commit names and tags)</li>
</ul>
<p>You can run it through <a href="https://docs.github.com/en/actions/managing-workflow-runs/manually-running-a-workflow">github.com</a></p>
<img alt="GitHub publish crate UI" decoding="async" height="457" src="../../media/github-publish-crate-ui.png.webp" width="1462" loading="lazy">
<p>Or from the command line with <a href="https://cli.github.com/">gh</a></p>
<video controls src="../../media/crates-gh-push.mp4" title="Crates GH push"></video>
<p>Which I can watch</p>
<img alt="GitHub publish crate watch" decoding="async" height="857" src="../../media/github-publish-crate-cl-watch.png.webp" width="1477" loading="lazy">
<p>Behind the scenes, it updates the packages in the order of least dependency (I don't want to rely on myself for ordering arguments, <a href="https://github.com/kaleidawave/crates-release-gh-action/blob/4dd293538aec8fc068acf08f35e60c0d015b7547/updater.py#L54-L66">it can be calculated</a>). It also uses a TOML parser that retains the TOML formatting. It is currently written in Python. If anyone wants to rewrite it in Rust and/or add more functionality, LMK!</p>
<blockquote>
<p>It is a manual action currently, and isn't particularly automated. It doesn't track changes in a workspace, or figure out <em>Semver</em> or build changelogs. I want the base to be simple and un-opinionated</p>
</blockquote>
<hr>
<p>I didn't have space but two more crates I have made are: <a href="https://crates.io/crates/multiline-term-input">multiline-term-input</a>, which is a way to break into new lines during console input (<a href="https://github.com/kaleidawave/multiline-term-input/issues/1">I need a wiz to add Linux support</a>) and <a href="https://crates.io/crates/temporary-annex">temporary-annex</a> that helps to work with appending data temporarily while reusing <strong>the same</strong> backing (linear) buffer.</p>
<p>And that is all. If you have built or used any cool Rust libraries or additional tools let me know in the comments!</p>

</div>

<div class="discussions">
    <script src="https://giscus.app/client.js" async crossorigin="anonymous" data-category="Comments" data-category-id="DIC_kwDOIy08KM4CTpn8" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-loading="lazy" data-mapping="pathname" data-reactions-enabled="1" data-repo="kaleidawave/discussions" data-repo-id="R_kgDOIy08KA" data-strict="0" data-theme="preferred_color_scheme">
            </script>
</div>

<script defer="defer">for(let video of document.querySelectorAll("video"))video.addEventListener("mouseover",e=>{e.target.play()});</script>

        </div>
        
    </main>
    <footer>
        <div class="width-box">
            <form>
                <label for="toggle-theme">Light Mode</label>
                <input id="toggle-theme" name="toggle-theme" type="checkbox">
            </form>
            <nav>
                <ul>
                    <li>
                        <a href="https://twitter.com/kaleidawave">Twitter <svg class="icon" role="img" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter icon</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg></a>
                    </li>
                    <li>
                        <a href="https://github.com/kaleidawave">GitHub <svg class="icon" role="img" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
                    </li>
                    <li>
                        Built with <a href="https://www.11ty.dev/"><svg class="icon" role="img" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Eleventy icon</title><path d="M3.398 12V0h17.204v24H3.398zm13.17 6.07a1.07 1.07 0 00.373-.107c.432-.213.68-.672.877-1.626.076-.372 1.195-6.168 1.209-6.263.026-.186-.008-.382-.084-.476a.325.325 0 00-.087-.064l-.06-.031h-.291c-.253 0-.298 0-.348.02-.113.039-.207.156-.255.316-.011.038-.168.881-.348 1.873l-.328 1.802-.046-.21c-.56-2.547-.764-3.452-.794-3.532a.383.383 0 00-.103-.16c-.105-.107-.117-.11-.567-.11-.411 0-.422 0-.5.074-.086.079-.122.216-.111.42.006.115.045.27.688 2.784.663 2.587.751 2.943.787 3.177.046.3-.05.713-.208.893-.032.037-.037.039-.084.032-.028 0-.12-.027-.204-.051-.268-.078-.362-.072-.462.028-.096.096-.137.248-.138.51 0 .256.028.34.159.473.131.133.324.208.595.23.164.012.22.012.33-.001zm-1.896-1.712a.31.31 0 00.16-.192c.02-.058.022-.098.022-.356 0-.255-.003-.299-.021-.354-.04-.121-.136-.196-.278-.217-.041-.01-.2-.01-.355-.01-.365-.001-.378-.01-.446-.184-.068-.18-.096-.326-.113-.602a85.799 85.799 0 01-.012-1.94v-1.765h.35c.454 0 .507-.01.602-.113a.465.465 0 00.102-.24 3.273 3.273 0 000-.534c-.026-.16-.099-.271-.211-.322-.057-.025-.065-.026-.45-.03h-.392l-.003-1.22c-.003-1.09-.005-1.227-.021-1.278a.378.378 0 00-.201-.247c-.052-.024-.072-.025-.32-.029-.27 0-.356 0-.429.038-.087.042-.148.133-.185.278-.014.054-.032.346-.076 1.262l-.06 1.194s-.08 0-.18.01c-.206.01-.263.022-.327.086-.092.092-.12.19-.127.455-.01.334.02.487.115.588.075.081.134.1.345.106l.173.01v1.785c0 1.7.006 2.019.034 2.274.041.37.13.709.241.928.194.38.544.617.988.668h1.005l.07-.04zm-7.447 0c.098-.053.16-.154.2-.332.016-.077.018-.401.018-4.518 0-4.184-.001-4.44-.02-4.51-.05-.194-.19-.29-.378-.26-.035.01-.344.084-.686.175-.343.09-.684.18-.758.198-.17.043-.214.062-.281.126-.105.098-.122.185-.122.606 0 .416.016.5.12.604.094.095.189.1.456.03.103-.026.193-.048.2-.048.01 0 .014.784.017 3.763.003 3.436.005 3.77.021 3.84.048.202.113.296.236.34.034.013.133.016.487.014.435 0 .445 0 .49-.027zm3.203 0c.092-.046.152-.135.197-.29l.024-.084.003-4.435c.002-3.194 0-4.456-.01-4.509-.033-.2-.145-.308-.322-.308-.066 0-.198.03-.857.204-.56.147-.799.214-.849.239a.34.34 0 00-.17.184c-.024.06-.024.071-.024.479 0 .415 0 .417.026.483a.362.362 0 00.083.12c.1.1.172.105.456.034a5.46 5.46 0 01.208-.05c.008 0 .012 1.202.014 3.791l.003 3.79.026.086a.48.48 0 00.135.23c.078.062.085.063.57.06.414 0 .447 0 .487-.024z"/></svg> Eleventy</a> and
                        <a href="/architecture">others</a>
                    </li>
                </ul>
            </nav>
        </div>
    </footer>
    <script>function changeScheme(e=null){null===e&&(e="matchMedia"in window&&window.matchMedia("(prefers-color-scheme: dark)").matches),localStorage.setItem("theme",e?"dark":"light"),updateThemeClass()}function updateThemeClass(e=null){null===e&&(e="dark"===localStorage.getItem("theme")),e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}null===localStorage.getItem("theme")?changeScheme():updateThemeClass();{let e=document.querySelector("#toggle-theme");e.checked="dark"!==localStorage.getItem("theme"),e.addEventListener("change",e=>{changeScheme(!e.target.checked)})}document.addEventListener("click",e=>{if(e.target.matches(".post > *:is(h2, h3, h4, h5)")){let t=e.target.getAttribute("id");null!==t&&(location.href="#"+t)}});let titleBar=document.querySelector("header .icon-title");for(let element of(console.log(titleBar.querySelector("img")),titleBar.querySelector("img").addEventListener("dragend",()=>{let e=document.createElement("video"),t=document.createElement("source");t.src="/media/boom.webm",e.append(t),e.controls=!1,titleBar.appendChild(e),e.addEventListener("ended",()=>{titleBar.querySelector(".header-title").innerText="Bengineering",e.style.display="none"}),e.play()}),document.querySelectorAll("[data-highlight]"))){let e=element.getAttribute("data-highlight").split(",").map(e=>parseInt(e));for(let t of element.children[0].children)for(let l of e){let e=t.children[0].children[l],n=e.children[0],a=n.textContent.trimLeft(),r=n.textContent.length-a.length;n.childNodes[0].data=a,e.style.marginLeft=r+"ch",e.classList.add("highlight")}}</script>


</body></html>